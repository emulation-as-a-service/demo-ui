var EaasClient=EaasClient||{};
EaasClient.Client=function(b,k){function d(a){var c=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,b){return"undefined"!=typeof c[b]?c[b]:a})}function h(a){var c={};if(!a)return c;a.split("\x26").forEach(function(a){a=a.split("\x3d");c[a[0]]=decodeURIComponent(a[1])});return c}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraConf={xpraWidth:640,xpraHeight:480,xpraDPI:96,xpraEncoding:"rgb32"};this.setXpraConf=function(a,c,g,b){xpraConf={xpraWidth:a,
xpraHeight:c,xpraDPI:g,xpraEncoding:b}};var a=this,f=b.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.componentId=null;var e;this.pollState=function(){$.get(f+d("/components/{0}/state",a.componentId)).then(function(b,c,g){e=b.state;if("OK"==e)a.keepalive();else if("STOPPED"==e||"FAILED"==e){if(a.keepalive(),a.onEmulatorStopped)a.onEmulatorStopped()}else"INACTIVE"==e?location.reload():a._onFatalError("Invalid component state: "+
this.emulatorState)}).fail(function(){a._onFatalError("connection failed")})};this._onFatalError=function(a){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"});console.error(a)};this._onResize=function(a,c){k.style.width=a;k.style.height=c;if(this.onResize)this.onResize(a,c)};this.keepalive=function(){var b=null;null!=a.networkId?b=d("/networks/{0}/keepalive",a.networkId):null!=a.componentId&&(b=
d("/components/{0}/keepalive",a.componentId));$.post(f+b)};this.establishGuacamoleTunnel=function(a){$.fn.focusWithoutScrolling=function(){var a=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(a,c);return this};if(this.guac){var c=this.guac.getDisplay().getElement();$(c).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);k.insertBefore(a,k.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),
"resize",this._onResize.bind(this));this.guac.connect();var c=new Guacamole.Mouse(a),b=new Guacamole.Mouse.Touchpad(a),l=new BwflaMouse(this.guac);c.onmousedown=b.onmousedown=l.onmousedown;c.onmouseup=b.onmouseup=l.onmouseup;c.onmousemove=b.onmousemove=l.onmousemove;c=new Guacamole.Keyboard(a);c.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);c.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});
if(this.onReady)this.onReady()};this.getContainerResultUrl=function(){console.log(a.componentId);return f+d("/components/{0}/result",a.componentId)};this.startContainer=function(b,c){var g={type:"container"};g.environment=b;g.input_data=c.input_data;console.log("Starting container "+b+"...");var l=$.Deferred();$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(g),contentType:"application/json"}).then(function(c,g,m){console.log("container "+b+" started.");a.componentId=c.id;a.isStarted=!0;
a.pollStateIntervalId=setInterval(a.pollState,1500);l.resolve()},function(c){a._onFatalError($.parseJSON(c.responseText));l.reject()});return l.promise()};this.startEnvironment=function(b,c){var g={type:"machine"};g.environment=b;"undefined"!==typeof c&&(g.keyboardLayout=c.keyboardLayout,g.keyboardModel=c.keyboardModel,g.object=c.object,null==c.object&&(g.software=c.software),g.userId=c.userId,c.lockEnvironment&&(g.lockEnvironment=!0));var l=$.Deferred();console.log("Starting environment "+b+"...");
$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(g),contentType:"application/json"}).then(function(c,g,e){console.log("Environment "+b+" started.");a.componentId=c.id;a.driveId=c.driveId;a.isStarted=!0;a.pollStateIntervalId=setInterval(a.pollState,1500);l.resolve()},function(c){a._onFatalError($.parseJSON(c.responseText));l.reject()});return l.promise()};this.connect=function(){var b=$.Deferred();if(!this.isStarted)return a._onFatalError("Environment was not started properly!"),b.reject(),
b.promise();console.log("Connecting viewer...");$.get(f+d("/components/{0}/controlurls",a.componentId)).done(function(c,g,l){if("undefined"!==typeof c.guacamole)g=c.guacamole,a.params=h(c.guacamole.substring(c.guacamole.indexOf("#")+1)),c=a.establishGuacamoleTunnel;else if("undefined"!==typeof c.xpra)g=c.xpra,a.params=h(c.xpra.substring(c.xpra.indexOf("#")+1)),c=a.prepareAndLoadXpra;else if("undefined"!==typeof c.webemulator)g=encodeURIComponent(JSON.stringify(c)),a.params=h(c.webemulator.substring(c.webemulator.indexOf("#")+
1)),c=a.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+c);b.reject();return}c.call(a,g);console.log("Viewer connected successfully.");a.isConnected=!0;b.resolve()}).fail(function(c){console.error("Connecting viewer failed!");a._onFatalError($.parseJSON(c.responseText));b.reject()});return b.promise()};this.disconnect=function(){var a=$.Deferred();if(!this.isConnected)return a.reject(),a.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();
console.log("Viewer disconnected successfully.");this.isConnected=!1;a.resolve();return a.promise()};this.checkpoint=function(b){var c=$.Deferred();if(!this.isStarted)return a._onFatalError("Environment was not started properly!"),c.reject(),c.promise();console.log("Checkpointing session...");$.ajax({type:"POST",url:f+d("/components/{0}/checkpoint",a.componentId),timeout:3E4,contentType:"application/json",data:JSON.stringify(b)}).done(function(a,b,e){a=a.envId;console.log("Checkpoint created: "+a);
c.resolve(a)}).fail(function(a,b,e){a=$.parseJSON(a.responseText);null!==a.message&&console.error("Server-Error:"+a.message);null!==e&&console.error("Ajax-Error: "+e);console.error("Checkpointing failed!");c.reject()});return c.promise()};this.getScreenshotUrl=function(){return f+d("/components/{0}/screenshot",a.componentId)};this.downloadPrint=function(b){return f+d("/components/{0}/downloadPrintJob?label\x3d{1}",a.componentId,encodeURI(b))};this.getPrintJobs=function(b,c){$.get(f+d("/components/{0}/printJobs",
a.componentId)).done(function(a,c,e){b(a)}).fail(function(a){c&&c(a)})};this.getEmulatorState=function(){if("undefined"!==typeof e)return e;console.warn("emulator state is not defined yet!");return"undefined"};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:f+d("/components/{0}/stop",a.componentId),async:!1}),this.isStarted=!1,$(k).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};
this.release=function(){for(var b=this.disconnect();"pending"===b.state(););this.stopEnvironment();this.clearTimer();$.ajax({type:"DELETE",url:f+d("/components/{0}",a.componentId),async:!1})};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(b,c,g){$.ajax({type:"POST",url:f+d("/components/{0}/snapshot",
a.componentId),data:JSON.stringify(b),contentType:"application/json"}).then(function(a,b,g){c(a,b)}).fail(function(a,b,c){g?g(c):(console.log(a.statusText),console.log(b),console.log(c))})};this.changeMedia=function(b,c){$.ajax({type:"POST",url:f+d("/components/{0}/changeMedia",a.componentId),data:JSON.stringify(b),contentType:"application/json"}).then(function(a,b,e){c(a,b)})};this.prepareAndLoadXpra=function(b){var c=document.getElementsByTagName("script"),g;for(g in c){var e="eaas-client.js";if("undefined"!=
typeof c[g].src&&-1!=c[g].src.indexOf(e))var d=c[g].src}var f=d.substring(0,d.indexOf(e))+"xpra/";jQuery.when(jQuery.getScript(f+"/eaas-xpra.js"),jQuery.getScript(f+"/js/lib/bencode.js"),jQuery.getScript(f+"/js/lib/zlib.js"),jQuery.getScript(f+"/js/lib/forge.js"),jQuery.getScript(f+"/js/lib/wsworker_check.js"),jQuery.getScript(f+"/js/lib/broadway/Decoder.js"),jQuery.getScript(f+"/js/lib/aurora/aurora-xpra.js"),
jQuery.getScript(f+"/js/Keycodes.js"),jQuery.getScript(f+"/js/Utilities.js"),jQuery.getScript(f+"/js/Notifications.js"),jQuery.getScript(f+"/js/MediaSourceUtil.js"),jQuery.getScript(f+"/js/Window.js"),jQuery.getScript(f+"/js/Protocol.js"),jQuery.getScript(f+"/js/Client.js"),jQuery.Deferred(function(a){jQuery(a.resolve)})).done(function(){loadXpra(b,f,a.xpraConf)})};this.prepareAndLoadWebEmulator=function(a){var b=document.getElementsByTagName("script"),g;for(g in b){var f="eaas-client.js";if("undefined"!=
typeof b[g].src&&-1!=b[g].src.indexOf(f))var e=b[g].src}b=e.substring(0,e.indexOf(f))+"webemulator/";g=document.createElement("iframe");g.setAttribute("style","width: 100%; height: 600px;");g.src=b+"#controlurls\x3d"+a;k.appendChild(g)};this.startEnvironmentWithAttachment=function(b,c,g){var e={type:"machine"};e.environment=b;e.input_data=g;"undefined"!==typeof c&&(e.keyboardLayout=c.keyboardLayout,e.keyboardModel=c.keyboardModel,e.object=c.object,null==c.object&&(e.software=c.software),e.userContext=
c.userContext);var d=$.Deferred();console.log("Starting environment "+b+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(c,e,g){console.log("Environment "+b+" started.");a.componentId=c.id;a.driveId=c.driveId;a.isStarted=!0;a.pollStateIntervalId=setInterval(a.pollState,1500);d.resolve()},function(b){a._onFatalError($.parseJSON(b.responseText));d.reject()});this.isAttachmentAvailable=!0;return d.promise()};this.startEnvironmentWithInternet=
function(b,c){var e={type:"machine"};e.environment=b;"undefined"!==typeof c&&(e.keyboardLayout=c.keyboardLayout,e.keyboardModel=c.keyboardModel,e.object=c.object,null==c.object&&(e.software=c.software),e.userId=c.userId);var d=$.Deferred();console.log("Starting environment "+b+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(c,e,g){console.log("Environment "+b+" started.");$.ajax({type:"POST",url:f+"/networks",data:JSON.stringify({components:[{componentId:c.id}],
hasInternet:!0}),contentType:"application/json"}).then(function(b,e,g){a.componentId=c.id;a.driveId=c.driveId;a.networkId=b.id;a.isStarted=!0;a.pollStateIntervalId=setInterval(a.pollState,1500);d.resolve()})},function(b){a._onFatalError($.parseJSON(xhr.responseText));d.reject()});return d.promise()};this.startDockerEnvironment=function(b,c){var e={type:"container"};e.environment=b;"undefined"!==typeof c&&(e.keyboardLayout=c.keyboardLayout,e.keyboardModel=c.keyboardModel,e.object=c.object,null==c.object&&
(e.software=c.software),e.userContext=c.userContext);var d=$.Deferred();console.log("Starting environment "+b+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(c,e,f){console.log("Environment "+b+" started.");a.componentId=c.id;a.driveId=c.driveId;a.isStarted=!0;a.pollStateIntervalId=setInterval(a.pollState,1500);d.resolve()},function(b){a._onFatalError($.parseJSON(b.responseText));d.reject()});return d.promise()};this.startConnectedEnvironments=
function(b,c,e){var d={type:"machine"};d.environment=b;"undefined"!==typeof e&&(d.keyboardLayout=e.keyboardLayout,d.keyboardModel=e.keyboardModel,d.object=e.object,null==e.object&&(d.software=e.software),d.userId=e.userId);var g=$.Deferred();console.log("Starting environment "+b+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(e,h,k){console.log("Environment "+b+" started.");d.environment=c;$.ajax({type:"POST",url:f+"/components",
data:JSON.stringify(d),contentType:"application/json"}).then(function(b,c,d){$.ajax({type:"POST",url:f+"/networks",data:JSON.stringify({components:[{componentId:e.id},{componentId:b.id}],hasInternet:!0}),contentType:"application/json"}).then(function(b,c,d){a.componentId=e.id;a.driveId=e.driveId;a.networkId=b.id;a.isStarted=!0;a.pollStateIntervalId=setInterval(a.pollState,1500);g.resolve()})})},function(b){a._onFatalError($.parseJSON(xhr.responseText));g.reject()});return g.promise()}};
var BWFLA=BWFLA||{};BWFLA.registerEventCallback=function(b,k,d){var h="on"+k;if(h in b){"__bwFlaEventHandlers__"in b||(b.constructor.prototype.__bwFlaEventHandlers__={});h in b.__bwFlaEventHandlers__||(b.__bwFlaEventHandlers__[h]=[]);var a=b.__bwFlaEventHandlers__[h];a.push(d);null==b[h]&&(b[h]=function(){var d=arguments;a.forEach(function(a){a.apply(b,d)})})}else console.error("Event "+k+" not supported!")};
BWFLA.unregisterEventCallback=function(b,k,d){"__bwFlaEventHandlers__"in b&&(b=b.__bwFlaEventHandlers__["on"+k],null!=b&&(d=b.indexOf(d),-1<d&&b.splice(d,1)))};
var BwflaMouse=function(b){function k(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function d(){for(;0<h.length;)b.sendMouseState(h.shift());a=null;f=!1}var h=[],a=null,f=!1;this.onmousedown=function(b){null!=a&&window.clearTimeout(a);a=window.setTimeout(d,100);k(b);f=!0};this.onmouseup=function(b){null!=a&&window.clearTimeout(a);a=window.setTimeout(d,150);k(b);f=!0};this.onmousemove=function(a){1==f?k(a):b.sendMouseState(a)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(b,k){function d(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(b.requestPointerLock=b.requestPointerLock||b.mozRequestPointerLock||b.webkitRequestPointerLock,b.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===b||document.mozPointerLockElement===b||document.webkitPointerLockElement===b?(console.debug("Pointer was locked!"),b.isPointerLockEnabled=!0,b.removeEventListener(k,d,!1)):(console.debug("Pointer was unlocked."),b.isPointerLockEnabled=!1,b.addEventListener(k,d,!1))}function a(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",a,!1);document.addEventListener("mozpointerlockerror",a,!1);document.addEventListener("webkitpointerlockerror",a,!1);b.addEventListener(k,d,!1);b.isRelativeMouse=!0};BWFLA.hideClientCursor=function(b){b.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(b){b.getDisplay().showCursor(!0)};BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(b,k,d){var h="on"+k;if(h in b){"__bwFlaEventHandlers__"in b||(b.constructor.prototype.__bwFlaEventHandlers__={});h in b.__bwFlaEventHandlers__||(b.__bwFlaEventHandlers__[h]=[]);var a=b.__bwFlaEventHandlers__[h];a.push(d);null==b[h]&&(b[h]=function(){var d=arguments;a.forEach(function(a){a.apply(b,d)})})}else console.error("Event "+k+" not supported!")};
BWFLA.unregisterEventCallback=function(b,k,d){"__bwFlaEventHandlers__"in b&&(b=b.__bwFlaEventHandlers__["on"+k],null!=b&&(d=b.indexOf(d),-1<d&&b.splice(d,1)))};
BwflaMouse=function(b){function k(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function d(){for(;0<h.length;)b.sendMouseState(h.shift());a=null;f=!1}var h=[],a=null,f=!1;this.onmousedown=function(b){null!=a&&window.clearTimeout(a);a=window.setTimeout(d,100);k(b);f=!0};this.onmouseup=function(b){null!=a&&window.clearTimeout(a);a=window.setTimeout(d,150);k(b);f=!0};this.onmousemove=function(a){1==f?k(a):b.sendMouseState(a)}};BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(b,k){function d(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(b.requestPointerLock=b.requestPointerLock||b.mozRequestPointerLock||b.webkitRequestPointerLock,b.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===b||document.mozPointerLockElement===b||document.webkitPointerLockElement===b?(console.debug("Pointer was locked!"),b.isPointerLockEnabled=!0,b.removeEventListener(k,d,!1)):(console.debug("Pointer was unlocked."),b.isPointerLockEnabled=!1,b.addEventListener(k,d,!1))}function a(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",a,!1);document.addEventListener("mozpointerlockerror",a,!1);document.addEventListener("webkitpointerlockerror",a,!1);b.addEventListener(k,d,!1);b.isRelativeMouse=!0};BWFLA.hideClientCursor=function(b){b.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(b){b.getDisplay().showCursor(!0)};