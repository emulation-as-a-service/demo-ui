var EaasClient=EaasClient||{};
EaasClient.Client=function(a,h){function e(b){var c=Array.prototype.slice.call(arguments,1);return b.replace(/{(\d+)}/g,function(b,a){return"undefined"!=typeof c[a]?c[a]:b})}function f(b){var c={};if(!b)return c;b.split("\x26").forEach(function(b){b=b.split("\x3d");c[b[0]]=decodeURIComponent(b[1])});return c}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraConf={xpraWidth:640,xpraHeight:480,xpraDPI:96,xpraEncoding:"rgb32"};this.setXpraConf=function(b,c,a,d){xpraConf={xpraWidth:b,
xpraHeight:c,xpraDPI:a,xpraEncoding:d}};var b=this,g=a.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.networkTcpInfo=this.componentId2=this.componentId=null;var d;this.pollState=function(){$.ajax({type:"GET",url:g+e("/components/{0}/state",b.componentId),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},async:!1}).then(function(a,c,k){d=a.state;if("OK"==d)b.keepalive();else if("STOPPED"==
d||"FAILED"==d){if(b.keepalive(),b.onEmulatorStopped)b.onEmulatorStopped()}else"INACTIVE"==d?location.reload():b._onFatalError("Invalid component state: "+this.emulatorState)}).fail(function(){b._onFatalError("connection failed")})};this._onFatalError=function(b){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(b||{error:"No error message specified"});console.error(b)};this._onResize=function(b,c){h.style.width=b;h.style.height=c;if(this.onResize)this.onResize(b,
c)};this.keepalive=function(){var a=null;if(null!=b.networkId){if("undefined"!=typeof b.envsComponentsData)for(a=0;a<b.envsComponentsData.length;a++)$.ajax({type:"POST",url:g+e("/components/{0}/keepalive",b.envsComponentsData[a].id),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}});a=e("/networks/{0}/keepalive",b.networkId)}else null!=b.componentId&&(a=e("/components/{0}/keepalive",b.componentId));$.ajax({type:"POST",url:g+a,headers:localStorage.getItem("id_token")?
{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}})};this.establishGuacamoleTunnel=function(b){$.fn.focusWithoutScrolling=function(){var b=window.scrollX,a=window.scrollY;this.focus();window.scrollTo(b,a);return this};if(this.guac){var a=this.guac.getDisplay().getElement();$(a).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(b.split("#")[0]));b=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);h.insertBefore(b,h.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),
"resize",this._onResize.bind(this));this.guac.connect();var a=new Guacamole.Mouse(b),k=new Guacamole.Mouse.Touchpad(b),d=new BwflaMouse(this.guac);a.onmousedown=k.onmousedown=d.onmousedown;a.onmouseup=k.onmouseup=d.onmouseup;a.onmousemove=k.onmousemove=d.onmousemove;a=new Guacamole.Keyboard(b);a.onkeydown=function(b){this.guac.sendKeyEvent(1,b)}.bind(this);a.onkeyup=function(b){this.guac.sendKeyEvent(0,b)}.bind(this);$(b).attr("tabindex","0");$(b).css("outline","0");$(b).mouseenter(function(){$(this).focusWithoutScrolling()});
if(this.onReady)this.onReady()};this.getContainerResultUrl=function(){console.log(b.componentId);return g+e("/components/{0}/result",b.componentId)};this.startContainer=function(a,c){var k={type:"container"};k.environment=a;k.input_data=c.input_data;console.log("Starting container "+a+"...");var d=$.Deferred();$.ajax({type:"POST",url:g+"/components",data:JSON.stringify(k),contentType:"application/json",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:
{}}).then(function(c,k,e){console.log("container "+a+" started.");b.componentId=c.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);d.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));d.reject()});return d.promise()};this.start=function(a,c){var k=function(a){components=[];for(var k=0;k<a.length;k++)components.push({componentId:a[k].id});$.ajax({type:"POST",url:g+"/networks",data:JSON.stringify({components:components,hasInternet:c.hasInternet?!0:!1}),contentType:"application/json",
headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).then(function(c,k,d){b.envsComponentsData=a;b.networkId=c.id;b.networkTcpInfo=null!=c.networkUrls?c.networkUrls.tcp:null;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);e.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));e.reject()})},d=function(a){for(var c=[],d={i:0};d.i<a.length;d={i:d.i},d.i++)console.log("env: "+a[d.i].data.environment),$.ajax({type:"POST",
url:g+"/components",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},success:function(k){return function(d,e,g){c.push(d);1==a[k.i].visualize&&(console.log("_this.componentId "+b.componentId),null!=b.componentId&&console.error("We support visualization of only one environment at the time!! Visualizing the last specified..."),b.componentId=d.id,b.driveId=d.driveId)}}(d),async:!1,data:JSON.stringify(a[d.i].data),contentType:"application/json"});
k(c)},e=$.Deferred();1<a.length?d(a):(console.log("Starting environment "+a[0].data.environment+"..."),$.ajax({type:"POST",url:g+"/components",data:JSON.stringify(a[0].data),contentType:"application/json",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).then(function(d,g,l){b.componentId=d.id;b.driveId=d.driveId;c.tcpGatewayConfig||c.hasInternet?k(d):(console.log("Environment "+a[0].data.environment+" started."),b.isStarted=!0,b.pollStateIntervalId=
setInterval(b.pollState,1500),e.resolve())},function(a){b._onFatalError($.parseJSON(a.responseText));e.reject()}));return e.promise()};this.startEnvironment=function(b,a){var c={type:"machine"};c.environment=b;"undefined"!==typeof a&&(c.keyboardLayout=a.keyboardLayout,c.keyboardModel=a.keyboardModel,c.object=a.object,null==a.object&&(c.software=a.software),c.userId=a.userId,a.lockEnvironment&&(c.lockEnvironment=!0));return this.start([{data:c,visualize:!0}],a)};this.connect=function(){var a=$.Deferred();
if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),a.reject(),a.promise();console.log("Connecting viewer...");$.ajax({type:"GET",url:g+e("/components/{0}/controlurls",b.componentId),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},async:!1}).done(function(c,d,e){if("undefined"!==typeof c.guacamole)d=c.guacamole,b.params=f(c.guacamole.substring(c.guacamole.indexOf("#")+1)),c=b.establishGuacamoleTunnel;else if("undefined"!==
typeof c.xpra)d=c.xpra,b.params=f(c.xpra.substring(c.xpra.indexOf("#")+1)),c=b.prepareAndLoadXpra;else if("undefined"!==typeof c.webemulator)d=encodeURIComponent(JSON.stringify(c)),b.params=f(c.webemulator.substring(c.webemulator.indexOf("#")+1)),c=b.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+c);a.reject();return}c.call(b,d);console.log("Viewer connected successfully.");b.isConnected=!0;a.resolve()}).fail(function(c){console.error("Connecting viewer failed!");b._onFatalError($.parseJSON(c.responseText));
a.reject()});return a.promise()};this.disconnect=function(){var a=$.Deferred();if(!this.isConnected)return a.reject(),a.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");this.isConnected=!1;a.resolve();return a.promise()};this.checkpoint=function(a){var c=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),c.reject(),c.promise();console.log("Checkpointing session...");$.ajax({type:"POST",
url:g+e("/components/{0}/checkpoint",b.componentId),timeout:3E4,contentType:"application/json",data:JSON.stringify(a),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).done(function(a,b,d){a=a.envId;console.log("Checkpoint created: "+a);c.resolve(a)}).fail(function(a,b,d){a=$.parseJSON(a.responseText);null!==a.message&&console.error("Server-Error:"+a.message);null!==d&&console.error("Ajax-Error: "+d);console.error("Checkpointing failed!");c.reject()});
return c.promise()};this.getScreenshotUrl=function(){return g+e("/components/{0}/screenshot",b.componentId)};this.downloadPrint=function(a){return g+e("/components/{0}/downloadPrintJob?label\x3d{1}",b.componentId,encodeURI(a))};this.getPrintJobs=function(a,c){$.ajax({type:"GET",url:g+e("/components/{0}/printJobs",b.componentId),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},async:!1}).done(function(b,c,d){a(b)}).fail(function(a){c&&c(a)})};this.getEmulatorState=
function(){if("undefined"!==typeof d)return d;console.warn("emulator state is not defined yet!");return"undefined"};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:g+e("/components/{0}/stop",b.componentId),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},async:!1}),this.isStarted=!1,$(h).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};
this.release=function(){for(var a=this.disconnect();"pending"===a.state(););this.stopEnvironment();this.clearTimer();$.ajax({type:"DELETE",url:g+e("/components/{0}",b.componentId),headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{},async:!1})};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,
65535)};this.snapshot=function(a,c,d){$.ajax({type:"POST",url:g+e("/components/{0}/snapshot",b.componentId),data:JSON.stringify(a),contentType:"application/json",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).then(function(a,b,d){c(a,b)}).fail(function(a,b,c){d?d(c):(console.log(a.statusText),console.log(b),console.log(c))})};this.changeMedia=function(a,c){$.ajax({type:"POST",url:g+e("/components/{0}/changeMedia",b.componentId),data:JSON.stringify(a),
contentType:"application/json",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).then(function(a,b,d){c(a,b)})};this.prepareAndLoadXpra=function(a){var c=document.getElementsByTagName("script"),d;for(d in c){var e="eaas-client.js";if("undefined"!=typeof c[d].src&&-1!=c[d].src.indexOf(e))var g=c[d].src}var f="undefined"==typeof g?"xpra/":g.substring(0,g.indexOf(e))+"xpra/";jQuery.when(jQuery.getScript(f+"/js/lib/zlib.js"),jQuery.getScript(f+"/js/lib/aurora/aurora.js"),
jQuery.getScript(f+"/js/lib/lz4.js"),jQuery.getScript(f+"/js/lib/jquery-ui.js"),jQuery.getScript(f+"/js/lib/jquery.ba-throttle-debounce.js"),jQuery.Deferred(function(a){jQuery(a.resolve)})).done(function(){jQuery.when(jQuery.getScript(f+"/js/lib/bencode.js"),jQuery.getScript(f+"/js/lib/forge.js"),jQuery.getScript(f+"/js/lib/wsworker_check.js"),jQuery.getScript(f+"/js/lib/broadway/Decoder.js"),jQuery.getScript(f+"/js/lib/aurora/aurora-xpra.js"),jQuery.getScript(f+"/eaas-xpra.js"),jQuery.getScript(f+
"/js/Keycodes.js"),jQuery.getScript(f+"/js/Utilities.js"),jQuery.getScript(f+"/js/Notifications.js"),jQuery.getScript(f+"/js/MediaSourceUtil.js"),jQuery.getScript(f+"/js/Window.js"),jQuery.getScript(f+"/js/Protocol.js"),jQuery.getScript(f+"/js/Client.js"),jQuery.Deferred(function(a){jQuery(a.resolve)})).done(function(){loadXpra(a,f,b.xpraConf)})})};this.prepareAndLoadWebEmulator=function(a){var b=document.getElementsByTagName("script"),d;for(d in b){var e="eaas-client.js";if("undefined"!=typeof b[d].src&&
-1!=b[d].src.indexOf(e))var f=b[d].src}b=f.substring(0,f.indexOf(e))+"webemulator/";d=document.createElement("iframe");d.setAttribute("style","width: 100%; height: 600px;");d.src=b+"#controlurls\x3d"+a;h.appendChild(d)};this.startDockerEnvironment=function(a,d){var c={type:"container"};c.environment=a;"undefined"!==typeof d&&(c.keyboardLayout=d.keyboardLayout,c.keyboardModel=d.keyboardModel,c.object=d.object,null==d.object&&(c.software=d.software),c.userContext=d.userContext);var e=$.Deferred();console.log("Starting environment "+
a+"...");$.ajax({type:"POST",url:g+"/components",data:JSON.stringify(c),contentType:"application/json",headers:localStorage.getItem("id_token")?{Authorization:"Bearer "+localStorage.getItem("id_token")}:{}}).then(function(d,c,f){console.log("Environment "+a+" started.");b.componentId=d.id;b.driveId=d.driveId;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);e.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));e.reject()});return e.promise()}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,h,e){var f="on"+h;if(f in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});f in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[f]=[]);var b=a.__bwFlaEventHandlers__[f];b.push(e);null==a[f]&&(a[f]=function(){var e=arguments;b.forEach(function(b){b.apply(a,e)})})}else console.error("Event "+h+" not supported!")};
BWFLA.unregisterEventCallback=function(a,h,e){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+h],null!=a&&(e=a.indexOf(e),-1<e&&a.splice(e,1)))};
var BwflaMouse=function(a){function h(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);f.push(a)}function e(){for(;0<f.length;)a.sendMouseState(f.shift());b=null;g=!1}var f=[],b=null,g=!1;this.onmousedown=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,100);h(a);g=!0};this.onmouseup=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,150);h(a);g=!0};this.onmousemove=function(b){1==g?h(b):a.sendMouseState(b)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,h){function e(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function f(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(h,e,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(h,e,!1))}function b(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",f,!1);document.addEventListener("mozpointerlockchange",f,!1);document.addEventListener("webkitpointerlockchange",
f,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);a.addEventListener(h,e,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,h,e){var f="on"+h;if(f in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});f in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[f]=[]);var b=a.__bwFlaEventHandlers__[f];b.push(e);null==a[f]&&(a[f]=function(){var e=arguments;b.forEach(function(b){b.apply(a,e)})})}else console.error("Event "+h+" not supported!")};
BWFLA.unregisterEventCallback=function(a,h,e){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+h],null!=a&&(e=a.indexOf(e),-1<e&&a.splice(e,1)))};
BwflaMouse=function(a){function h(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);f.push(a)}function e(){for(;0<f.length;)a.sendMouseState(f.shift());b=null;g=!1}var f=[],b=null,g=!1;this.onmousedown=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,100);h(a);g=!0};this.onmouseup=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,150);h(a);g=!0};this.onmousemove=function(b){1==g?h(b):a.sendMouseState(b)}};BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,h){function e(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function f(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(h,e,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(h,e,!1))}function b(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",f,!1);document.addEventListener("mozpointerlockchange",f,!1);document.addEventListener("webkitpointerlockchange",
f,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);a.addEventListener(h,e,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};