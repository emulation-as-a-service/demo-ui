var EaasClient=EaasClient||{};
EaasClient.Client=function(a,k){function f(b){var c=Array.prototype.slice.call(arguments,1);return b.replace(/{(\d+)}/g,function(b,a){return"undefined"!=typeof c[a]?c[a]:b})}function h(b){var c={};if(!b)return c;b.split("\x26").forEach(function(b){b=b.split("\x3d");c[b[0]]=decodeURIComponent(b[1])});return c}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraConf={xpraWidth:640,xpraHeight:480,xpraDPI:96,xpraEncoding:"rgb32"};this.setXpraConf=function(b,c,a,m){xpraConf={xpraWidth:b,
xpraHeight:c,xpraDPI:a,xpraEncoding:m}};var b=this,e=a.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.componentId=null;var g;this.pollState=function(){$.get(e+f("/components/{0}/state",b.componentId)).then(function(a,c,d){g=a.state;if("OK"==g)b.keepalive();else if("STOPPED"==g||"FAILED"==g){if(b.keepalive(),b.onEmulatorStopped)b.onEmulatorStopped()}else"INACTIVE"==g?location.reload():b._onFatalError("Invalid component state: "+
this.emulatorState)}).fail(function(){b._onFatalError("connection failed")})};this._onFatalError=function(b){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(b||{error:"No error message specified"});console.error(b)};this._onResize=function(b,c){k.style.width=b;k.style.height=c;if(this.onResize)this.onResize(b,c)};this.keepalive=function(){var a=null;null!=b.networkId?a=f("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&(a=
f("/components/{0}/keepalive",b.componentId));$.post(e+a)};this.establishGuacamoleTunnel=function(b){$.fn.focusWithoutScrolling=function(){var b=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(b,c);return this};if(this.guac){var c=this.guac.getDisplay().getElement();$(c).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(b.split("#")[0]));b=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);k.insertBefore(b,k.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),
"resize",this._onResize.bind(this));this.guac.connect();var c=new Guacamole.Mouse(b),a=new Guacamole.Mouse.Touchpad(b),l=new BwflaMouse(this.guac);c.onmousedown=a.onmousedown=l.onmousedown;c.onmouseup=a.onmouseup=l.onmouseup;c.onmousemove=a.onmousemove=l.onmousemove;c=new Guacamole.Keyboard(b);c.onkeydown=function(b){this.guac.sendKeyEvent(1,b)}.bind(this);c.onkeyup=function(b){this.guac.sendKeyEvent(0,b)}.bind(this);$(b).attr("tabindex","0");$(b).css("outline","0");$(b).mouseenter(function(){$(this).focusWithoutScrolling()});
if(this.onReady)this.onReady()};this.startEnvironment=function(a,c){var d={type:"machine"};d.environment=a;"undefined"!==typeof c&&(d.keyboardLayout=c.keyboardLayout,d.keyboardModel=c.keyboardModel,d.object=c.object,null==c.object&&(d.software=c.software),d.userId=c.userId,c.lockEnvironment&&(d.lockEnvironment=!0));var l=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(c,d,g){console.log("Environment "+
a+" started.");b.componentId=c.id;b.driveId=c.driveId;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);l.resolve()},function(c){b._onFatalError($.parseJSON(c.responseText));l.reject()});return l.promise()};this.connect=function(){var a=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),a.reject(),a.promise();console.log("Connecting viewer...");$.get(e+f("/components/{0}/controlurls",b.componentId)).done(function(c,d,l){if("undefined"!==
typeof c.guacamole)d=c.guacamole,b.params=h(c.guacamole.substring(c.guacamole.indexOf("#")+1)),c=b.establishGuacamoleTunnel;else if("undefined"!==typeof c.xpra)d=c.xpra,b.params=h(c.xpra.substring(c.xpra.indexOf("#")+1)),c=b.prepareAndLoadXpra;else if("undefined"!==typeof c.webemulator)d=encodeURIComponent(JSON.stringify(c)),b.params=h(c.webemulator.substring(c.webemulator.indexOf("#")+1)),c=b.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+c);a.reject();return}c.call(b,
d);console.log("Viewer connected successfully.");b.isConnected=!0;a.resolve()}).fail(function(c){console.error("Connecting viewer failed!");b._onFatalError($.parseJSON(c.responseText));a.reject()});return a.promise()};this.disconnect=function(){var b=$.Deferred();if(!this.isConnected)return b.reject(),b.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");this.isConnected=!1;b.resolve();return b.promise()};this.checkpoint=
function(){var a=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),a.reject(),a.promise();console.log("Checkpointing session...");$.ajax({type:"POST",url:e+f("/components/{0}/checkpoint",b.componentId),timeout:3E4}).done(function(b,d,g){b=b.environment_id;console.log("Checkpoint created: "+b);a.resolve(b)}).fail(function(b,d,g){b=$.parseJSON(b.responseText);null!==b.message&&console.error("Server-Error:"+b.message);null!==g&&console.error("Ajax-Error: "+
g);console.error("Checkpointing failed!");a.reject()});return a.promise()};this.getScreenshotUrl=function(){return e+f("/components/{0}/screenshot",b.componentId)};this.downloadPrint=function(a){return e+f("/components/{0}/downloadPrintJob?label\x3d{1}",b.componentId,encodeURI(a))};this.getPrintJobs=function(a,c){$.get(e+f("/components/{0}/printJobs",b.componentId)).done(function(b,c,g){a(b)}).fail(function(b){c&&c(b)})};this.getEmulatorState=function(){if("undefined"!==typeof g)return g;console.warn("emulator state is not defined yet!");
return"undefined"};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:e+f("/components/{0}/stop",b.componentId),async:!1}),this.isStarted=!1,$(k).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){for(var a=this.disconnect();"pending"===a.state(););this.stopEnvironment();this.clearTimer();$.ajax({type:"DELETE",url:e+f("/components/{0}",b.componentId),async:!1})};
this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(a,c,d){$.ajax({type:"POST",url:e+f("/components/{0}/snapshot",b.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(b,a,d){c(b,a)}).fail(function(b,a,c){d?d(c):(console.log(b.statusText),console.log(a),console.log(c))})};this.changeMedia=
function(a,c){$.ajax({type:"POST",url:e+f("/components/{0}/changeMedia",b.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(b,a,g){c(b,a)})};this.prepareAndLoadXpra=function(a){var c=document.getElementsByTagName("script"),d;for(d in c){var g="eaas-client.js";if("undefined"!=typeof c[d].src&&-1!=c[d].src.indexOf(g))var f=c[d].src}var e=f.substring(0,f.indexOf(g))+"xpra/";jQuery.when(jQuery.getScript(e+"/eaas-xpra.js"),jQuery.getScript(e+"/js/lib/jquery-ui.js"),jQuery.getScript(e+
"/js/lib/jquery.ba-throttle-debounce.js"),jQuery.getScript(e+"/js/lib/bencode.js"),jQuery.getScript(e+"/js/lib/zlib.js"),jQuery.getScript(e+"/js/lib/forge.js"),jQuery.getScript(e+"/js/lib/wsworker_check.js"),jQuery.getScript(e+"/js/lib/broadway/Decoder.js"),jQuery.getScript(e+"/js/lib/aurora/aurora-xpra.js"),jQuery.getScript(e+"/js/Keycodes.js"),jQuery.getScript(e+"/js/Utilities.js"),jQuery.getScript(e+"/js/Notifications.js"),jQuery.getScript(e+"/js/MediaSourceUtil.js"),jQuery.getScript(e+"/js/Window.js"),
jQuery.getScript(e+"/js/Protocol.js"),jQuery.getScript(e+"/js/Client.js"),jQuery.Deferred(function(b){jQuery(b.resolve)})).done(function(){loadXpra(a,e,b.xpraConf)})};this.prepareAndLoadWebEmulator=function(b){var a=document.getElementsByTagName("script"),d;for(d in a){var g="eaas-client.js";if("undefined"!=typeof a[d].src&&-1!=a[d].src.indexOf(g))var e=a[d].src}a=e.substring(0,e.indexOf(g))+"webemulator/";d=document.createElement("iframe");d.setAttribute("style","width: 100%; height: 600px;");d.src=
a+"#controlurls\x3d"+b;k.appendChild(d)};this.startEnvironmentWithAttachment=function(a,c){var d={type:"machine"};d.environment=a;d.input_data=[{type:"HDD",partition_table_type:"MBR",filesystem_type:"FAT32",size_mb:1024,content:[{action:"extract",compression_format:"TAR",url:"http://132.230.4.15/objects/ub/policy.tar",name:"test"}]}];"undefined"!==typeof c&&(d.keyboardLayout=c.keyboardLayout,d.keyboardModel=c.keyboardModel,d.object=c.object,null==c.object&&(d.software=c.software),d.userContext=c.userContext);
var g=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(c,d,e){console.log("Environment "+a+" started.");b.componentId=c.id;b.driveId=c.driveId;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);g.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));g.reject()});this.isAttachmentAvailable=!0;return g.promise()};this.startEnvironmentWithInternet=function(a,
c){var d={type:"machine"};d.environment=a;"undefined"!==typeof c&&(d.keyboardLayout=c.keyboardLayout,d.keyboardModel=c.keyboardModel,d.object=c.object,null==c.object&&(d.software=c.software),d.userId=c.userId);var g=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(c,d,f){console.log("Environment "+a+" started.");$.ajax({type:"POST",url:e+"/networks",data:JSON.stringify({components:[{componentId:c.id}],
hasInternet:!0}),contentType:"application/json"}).then(function(a,d,e){b.componentId=c.id;b.driveId=c.driveId;b.networkId=a.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);g.resolve()})},function(a){b._onFatalError($.parseJSON(xhr.responseText));g.reject()});return g.promise()};this.startDockerEnvironment=function(a,c){var d={type:"container"};d.environment=a;"undefined"!==typeof c&&(d.keyboardLayout=c.keyboardLayout,d.keyboardModel=c.keyboardModel,d.object=c.object,null==c.object&&
(d.software=c.software),d.userContext=c.userContext);var g=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(c,d,e){console.log("Environment "+a+" started.");b.componentId=c.id;b.driveId=c.driveId;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);g.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));g.reject()});return g.promise()};this.startConnectedEnvironments=
function(a,c,d){var g={type:"machine"};g.environment=a;"undefined"!==typeof d&&(g.keyboardLayout=d.keyboardLayout,g.keyboardModel=d.keyboardModel,g.object=d.object,null==d.object&&(g.software=d.software),g.userId=d.userId);var f=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(g),contentType:"application/json"}).then(function(d,h,k){console.log("Environment "+a+" started.");g.environment=c;$.ajax({type:"POST",url:e+"/components",
data:JSON.stringify(g),contentType:"application/json"}).then(function(a,c,g){$.ajax({type:"POST",url:e+"/networks",data:JSON.stringify({components:[{componentId:d.id},{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(a,c,g){b.componentId=d.id;b.driveId=d.driveId;b.networkId=a.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);f.resolve()})})},function(a){b._onFatalError($.parseJSON(xhr.responseText));f.reject()});return f.promise()}};
var BWFLA=BWFLA||{};BWFLA.registerEventCallback=function(a,k,f){var h="on"+k;if(h in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});h in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[h]=[]);var b=a.__bwFlaEventHandlers__[h];b.push(f);null==a[h]&&(a[h]=function(){var e=arguments;b.forEach(function(b){b.apply(a,e)})})}else console.error("Event "+k+" not supported!")};
BWFLA.unregisterEventCallback=function(a,k,f){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+k],null!=a&&(f=a.indexOf(f),-1<f&&a.splice(f,1)))};
var BwflaMouse=function(a){function k(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function f(){for(;0<h.length;)a.sendMouseState(h.shift());b=null;e=!1}var h=[],b=null,e=!1;this.onmousedown=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,100);k(a);e=!0};this.onmouseup=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,150);k(a);e=!0};this.onmousemove=function(b){1==e?k(b):a.sendMouseState(b)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,k){function f(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(k,f,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(k,f,!1))}function b(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);a.addEventListener(k,f,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,k,f){var h="on"+k;if(h in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});h in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[h]=[]);var b=a.__bwFlaEventHandlers__[h];b.push(f);null==a[h]&&(a[h]=function(){var e=arguments;b.forEach(function(b){b.apply(a,e)})})}else console.error("Event "+k+" not supported!")};
BWFLA.unregisterEventCallback=function(a,k,f){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+k],null!=a&&(f=a.indexOf(f),-1<f&&a.splice(f,1)))};
BwflaMouse=function(a){function k(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function f(){for(;0<h.length;)a.sendMouseState(h.shift());b=null;e=!1}var h=[],b=null,e=!1;this.onmousedown=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,100);k(a);e=!0};this.onmouseup=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,150);k(a);e=!0};this.onmousemove=function(b){1==e?k(b):a.sendMouseState(b)}};BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,k){function f(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(k,f,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(k,f,!1))}function b(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);a.addEventListener(k,f,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};