var EaasClient=EaasClient||{};
EaasClient.Client=function(d,k){function f(c){var a=Array.prototype.slice.call(arguments,1);return c.replace(/{(\d+)}/g,function(c,b){return"undefined"!=typeof a[b]?a[b]:c})}function l(c){var a={};if(!c)return a;c.split("\x26").forEach(function(c){c=c.split("\x3d");a[c[0]]=decodeURIComponent(c[1])});return a}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraConf={xpraWidth:640,xpraHeight:480,xpraDPI:96,xpraRestrictedEncodings:["png","rgb32"]};this.setXpraConf=function(c,a,b,m){xpraConf=
{xpraWidth:c,xpraHeight:a,xpraDPI:b,xpraRestrictedEncodings:m}};var b=this,h=d.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.componentId=null;var e;this.pollState=function(){$.get(h+f("/components/{0}/state",b.componentId)).then(function(c,a,g){e=c.state;if("OK"==e)b.keepalive();else if("STOPPED"==e||"FAILED"==e){if(b.keepalive(),b.onEmulatorStopped)b.onEmulatorStopped()}else"INACTIVE"==e?location.reload():b._onFatalError("Invalid component state: "+
this.emulatorState)}).fail(function(){b._onFatalError("connection failed")})};this._onFatalError=function(c){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(c||{error:"No error message specified"});console.error(c)};this._onResize=function(c,a){k.style.width=c;k.style.height=a;if(this.onResize)this.onResize(c,a)};this.keepalive=function(){var c=null;null!=b.networkId?c=f("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&(c=
f("/components/{0}/keepalive",b.componentId));$.post(h+c)};this.establishGuacamoleTunnel=function(c){$.fn.focusWithoutScrolling=function(){var a=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(a,c);return this};if(this.guac){var a=this.guac.getDisplay().getElement();$(a).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(c.split("#")[0]));c=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);k.insertBefore(c,k.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),
"resize",this._onResize.bind(this));this.guac.connect();var a=new Guacamole.Mouse(c),b=new Guacamole.Mouse.Touchpad(c),m=new BwflaMouse(this.guac);a.onmousedown=b.onmousedown=m.onmousedown;a.onmouseup=b.onmouseup=m.onmouseup;a.onmousemove=b.onmousemove=m.onmousemove;a=new Guacamole.Keyboard(c);a.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);a.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(c).attr("tabindex","0");$(c).css("outline","0");$(c).mouseenter(function(){$(this).focusWithoutScrolling()});
if(this.onReady)this.onReady()};this.startEnvironment=function(c,a){var g={type:"machine"};g.environment=c;"undefined"!==typeof a&&(g.keyboardLayout=a.keyboardLayout,g.keyboardModel=a.keyboardModel,g.object=a.object,null==a.object&&(g.software=a.software),g.userId=a.userId,a.lockEnvironment&&(g.lockEnvironment=!0));var m=$.Deferred();console.log("Starting environment "+c+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(g),contentType:"application/json"}).then(function(a,g,d){console.log("Environment "+
c+" started.");b.componentId=a.id;b.driveId=a.driveId;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);m.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));m.reject()});return m.promise()};this.connect=function(){var c=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),c.reject(),c.promise();console.log("Connecting viewer...");$.get(h+f("/components/{0}/controlurls",b.componentId)).done(function(a,g,d){if("undefined"!==
typeof a.guacamole)g=a.guacamole,b.params=l(a.guacamole.substring(a.guacamole.indexOf("#")+1)),a=b.establishGuacamoleTunnel;else if("undefined"!==typeof a.xpra)g=a.xpra,b.params=l(a.xpra.substring(a.xpra.indexOf("#")+1)),a=b.prepareAndLoadXpra;else if("undefined"!==typeof a.webemulator)g=encodeURIComponent(JSON.stringify(a)),b.params=l(a.webemulator.substring(a.webemulator.indexOf("#")+1)),a=b.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+a);c.reject();return}a.call(b,
g);console.log("Viewer connected successfully.");b.isConnected=!0;c.resolve()}).fail(function(a){console.error("Connecting viewer failed!");b._onFatalError($.parseJSON(a.responseText));c.reject()});return c.promise()};this.disconnect=function(){var c=$.Deferred();if(!this.isConnected)return c.reject(),c.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");this.isConnected=!1;c.resolve();return c.promise()};this.checkpoint=
function(){var c=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),c.reject(),c.promise();console.log("Checkpointing session...");$.ajax({type:"POST",url:h+f("/components/{0}/checkpoint",b.componentId),timeout:3E4}).done(function(a,b,d){a=a.environment_id;console.log("Checkpoint created: "+a);c.resolve(a)}).fail(function(a,b,d){a=$.parseJSON(a.responseText);null!==a.message&&console.error("Server-Error:"+a.message);null!==d&&console.error("Ajax-Error: "+
d);console.error("Checkpointing failed!");c.reject()});return c.promise()};this.getScreenshotUrl=function(){return h+f("/components/{0}/screenshot",b.componentId)};this.downloadPrint=function(c){return h+f("/components/{0}/downloadPrintJob?label\x3d{1}",b.componentId,encodeURI(c))};this.getPrintJobs=function(c,a){$.get(h+f("/components/{0}/printJobs",b.componentId)).done(function(a,b,d){c(a)}).fail(function(c){a&&a(c)})};this.getEmulatorState=function(){if("undefined"!==typeof e)return e;console.warn("emulator state is not defined yet!");
return"undefined"};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:h+f("/components/{0}/stop",b.componentId),async:!1}),this.isStarted=!1,$(k).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){for(var c=this.disconnect();"pending"===c.state(););this.stopEnvironment();this.clearTimer();$.ajax({type:"DELETE",url:h+f("/components/{0}",b.componentId),async:!1})};
this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(c,a,g){$.ajax({type:"POST",url:h+f("/components/{0}/snapshot",b.componentId),data:JSON.stringify(c),contentType:"application/json"}).then(function(c,b,g){a(c,b)}).fail(function(a,c,b){g?g(b):(console.log(a.statusText),console.log(c),console.log(b))})};this.changeMedia=
function(c,a){$.ajax({type:"POST",url:h+f("/components/{0}/changeMedia",b.componentId),data:JSON.stringify(c),contentType:"application/json"}).then(function(c,b,d){a(c,b)})};this.prepareAndLoadXpra=function(c){var a=document.getElementsByTagName("script"),g;for(g in a){var d="eaas-client.js";if("undefined"!=typeof a[g].src&&-1!=a[g].src.indexOf(d))var f=a[g].src}var e=f.substring(0,f.indexOf(d))+"xpra/";$.when($.getScript(e+"/eaas-xpra.js"),$.getScript(e+"/js/lib/jquery-ui.js"),$.getScript(e+"/js/lib/jquery.ba-throttle-debounce.js"),
$.getScript(e+"/js/lib/bencode.js"),$.getScript(e+"/js/lib/zlib.js"),$.getScript(e+"/js/lib/lz4.js"),$.getScript(e+"/js/lib/forge.js"),$.getScript(e+"/js/lib/broadway/Decoder.js"),$.getScript(e+"/js/lib/aurora/aurora-xpra.js"),$.getScript(e+"/js/Utilities.js"),$.getScript(e+"/js/Keycodes.js"),$.getScript(e+"/js/Notifications.js"),$.getScript(e+"/js/MediaSourceUtil.js"),$.getScript(e+"/js/Window.js"),$.getScript(e+"/js/Protocol.js"),$.getScript(e+"/js/Client.js"),$.getScript(e+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){loadXpra(c,
e,b.xpraConf)})};this.prepareAndLoadWebEmulator=function(c){var a=document.getElementsByTagName("script"),b;for(b in a){var d="eaas-client.js";if("undefined"!=typeof a[b].src&&-1!=a[b].src.indexOf(d))var e=a[b].src}a=e.substring(0,e.indexOf(d))+"webemulator/";b=document.createElement("iframe");b.setAttribute("style","width: 100%; height: 600px;");b.src=a+"#controlurls\x3d"+c;k.appendChild(b)};this.startEnvironmentWithInternet=function(c,a){var d={type:"machine"};d.environment=c;"undefined"!==typeof a&&
(d.keyboardLayout=a.keyboardLayout,d.keyboardModel=a.keyboardModel,d.object=a.object,null==a.object&&(d.software=a.software),d.userId=a.userId);var e=$.Deferred();console.log("Starting environment "+c+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(a,d,g){console.log("Environment "+c+" started.");$.ajax({type:"POST",url:h+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(c,
d,g){b.componentId=a.id;b.driveId=a.driveId;b.networkId=c.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);e.resolve()})},function(a){b._onFatalError($.parseJSON(xhr.responseText));e.reject()});return e.promise()};this.startConnectedEnvironments=function(c,a,d){var e={type:"machine"};e.environment=c;"undefined"!==typeof d&&(e.keyboardLayout=d.keyboardLayout,e.keyboardModel=d.keyboardModel,e.object=d.object,null==d.object&&(e.software=d.software),e.userId=d.userId);var f=$.Deferred();
console.log("Starting environment "+c+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(d,g,k){console.log("Environment "+c+" started.");e.environment=a;$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(a,c,e){$.ajax({type:"POST",url:h+"/networks",data:JSON.stringify({components:[{componentId:d.id},{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(a,
c,e){b.componentId=d.id;b.driveId=d.driveId;b.networkId=a.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);f.resolve()})})},function(a){b._onFatalError($.parseJSON(xhr.responseText));f.reject()});return f.promise()}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(d,k,f){var l="on"+k;if(l in d){"__bwFlaEventHandlers__"in d||(d.constructor.prototype.__bwFlaEventHandlers__={});l in d.__bwFlaEventHandlers__||(d.__bwFlaEventHandlers__[l]=[]);var b=d.__bwFlaEventHandlers__[l];b.push(f);null==d[l]&&(d[l]=function(){var f=arguments;b.forEach(function(b){b.apply(d,f)})})}else console.error("Event "+k+" not supported!")};
BWFLA.unregisterEventCallback=function(d,k,f){"__bwFlaEventHandlers__"in d&&(d=d.__bwFlaEventHandlers__["on"+k],null!=d&&(f=d.indexOf(f),-1<f&&d.splice(f,1)))};
var BwflaMouse=function(d){function k(b){b=new Guacamole.Mouse.State(b.x,b.y,b.left,b.middle,b.right,b.up,b.down);l.push(b)}function f(){for(;0<l.length;)d.sendMouseState(l.shift());b=null;h=!1}var l=[],b=null,h=!1;this.onmousedown=function(d){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,100);k(d);h=!0};this.onmouseup=function(d){null!=b&&window.clearTimeout(b);b=window.setTimeout(f,150);k(d);h=!0};this.onmousemove=function(b){1==h?k(b):d.sendMouseState(b)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(d,k){function f(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(d.requestPointerLock=d.requestPointerLock||d.mozRequestPointerLock||d.webkitRequestPointerLock,d.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function l(){document.pointerLockElement===d||document.mozPointerLockElement===d||document.webkitPointerLockElement===d?(console.debug("Pointer was locked!"),d.isPointerLockEnabled=!0,d.removeEventListener(k,f,!1)):(console.debug("Pointer was unlocked."),d.isPointerLockEnabled=!1,d.addEventListener(k,f,!1))}function b(b){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",l,!1);document.addEventListener("mozpointerlockchange",l,!1);document.addEventListener("webkitpointerlockchange",
l,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);d.addEventListener(k,f,!1);d.isRelativeMouse=!0};BWFLA.hideClientCursor=function(d){d.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(d){d.getDisplay().showCursor(!0)};