var EaasClient=EaasClient||{};
EaasClient.Client=function(b,f){function g(c){var a=Array.prototype.slice.call(arguments,1);return c.replace(/{(\d+)}/g,function(c,d){return"undefined"!=typeof a[d]?a[d]:c})}function h(c){var a={};if(!c)return a;c.split("\x26").forEach(function(c){c=c.split("\x3d");a[c[0]]=decodeURIComponent(c[1])})}function k(){var c=document.getElementsByTagName("script"),a;for(a in c){var d="eaas-client.js";if("undefined"!=typeof c[a].src&&-1!=c[a].src.indexOf(d))var b=c[a].src}return b.substring(0,b.indexOf(d))}
function m(c){var a=k()+"xpra/";$.when($.getScript(a+"/eaas-xpra.js"),$.getScript(a+"/js/lib/jquery-ui.js"),$.getScript(a+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(a+"/js/lib/bencode.js"),$.getScript(a+"/js/lib/zlib.js"),$.getScript(a+"/js/lib/lz4.js"),$.getScript(a+"/js/lib/forge.js"),$.getScript(a+"/js/lib/broadway/Decoder.js"),$.getScript(a+"/js/lib/aurora/aurora-xpra.js"),$.getScript(a+"/js/Utilities.js"),$.getScript(a+"/js/Keycodes.js"),$.getScript(a+"/js/Notifications.js"),$.getScript(a+
"/js/MediaSourceUtil.js"),$.getScript(a+"/js/Window.js"),$.getScript(a+"/js/Protocol.js"),$.getScript(a+"/js/Client.js"),$.getScript(a+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){I(c,a)})}xpraShapes={xpraWidth:1024,xpraHeight:768,xpraDPI:96};this.setXpraShapes=function(c,a,d){xpraShapes={xpraWidth:c,xpraHeight:a,xpraDPI:d}};var d=this,l=b.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.params=this.driveId=this.networkId=this.componentId=null;var n=!1;this.pollState=
function(c){$.get(l+g("/components/{0}/state",d.componentId)).then(function(a,c,b){n?(a=a.state,"OK"==a?d.keepalive():"INACTIVE"==a?location.reload():d._onError("Invalid component state: "+a)):$.get(l+g("/components/{0}/controlurls",d.componentId)).then(function(a,c,b){if(a.webemulator)for(c=document.createElement("iframe"),c.setAttribute("style","width: 100%; height: 600px;"),c.src=k()+"webemulator/#"+a.webemulator,c.src="https://ca5.de/webemulator/#controlurls\x3d"+encodeURIComponent(JSON.stringify(a)),
f.appendChild(c),n=!0,a=0;a<p.length;a++){if(p[a])p[a]()}else"undefined"!==typeof a.xpra?(d.params=h(a.xpra.substring(a.xpra.indexOf("#")+1)),m(a.xpra)):(d.params=h(a.guacamole.substring(a.guacamole.indexOf("#")+1)),d.establishGuacamoleTunnel(a.guacamole));d.pollStateInterval=setInterval(d.pollState,1500);n=!0;for(a=0;a<p.length;a++)if(p[a])p[a]()})},function(a){d._onError($.parseJSON(a.responseText))})};var p=[];this.addOnConnectListener=function(c){console.log("hasConnected, after"+n);if(n)return c(),
{remove:function(){}};var a=p.push(c)-1;return{remove:function(){delete p[a]}}};this._onError=function(c){this.keepaliveIntervalId&&clearInterval(this.keepaliveIntervalId);this.guac&&this.guac.disconnect();if(this.onError)this.onError(c||{error:"No error message specified"})};this._onResize=function(c,a){f.style.width=c;f.style.height=a;if(this.onResize)this.onResize(c,a)};this.keepalive=function(){var c=null;null!=d.networkId?c=g("/networks/{0}/keepalive",d.networkId):null!=d.componentId&&(c=g("/components/{0}/keepalive",
d.componentId));$.post(l+c)};this.establishGuacamoleTunnel=function(c){window.onbeforeunload=function(){this.guac.disconnect()}.bind(this);$.fn.focusWithoutScrolling=function(){var a=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(a,c);return this};this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(c.split("#")[0]));c=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);f.insertBefore(c,f.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));
this.guac.connect();var a=new Guacamole.Mouse(c),d=new Guacamole.Mouse.Touchpad(c),b=new BwflaMouse(this.guac);a.onmousedown=d.onmousedown=b.onmousedown;a.onmouseup=d.onmouseup=b.onmouseup;a.onmousemove=d.onmousemove=b.onmousemove;a=new Guacamole.Keyboard(c);a.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);a.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(c).attr("tabindex","0");$(c).css("outline","0");$(c).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};
this.startEnvironment=function(c,a){var b={type:"machine"};b.environment=c;"undefined"!==typeof a&&(b.keyboardLayout=a.keyboardLayout,b.keyboardModel=a.keyboardModel,b.object=a.object,null==a.object&&(b.software=a.software));$.ajax({type:"POST",url:l+"/components",data:JSON.stringify(b),contentType:"application/json"}).then(function(a,c,b){d.componentId=a.id;d.driveId=a.driveId;d.pollState()},function(a){d._onError($.parseJSON(a.responseText))})};this.getScreenshotUrl=function(){return l+g("/components/{0}/screenshot",
d.componentId)};this.getPrintUrl=function(){return l+g("/components/{0}/print",d.componentId)};this.stopEnvironment=function(){this.guac.disconnect();$.ajax({type:"GET",url:l+g("/components/{0}/stop",d.componentId),async:!1});$(f).empty()};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);
this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.changeMedia=function(c,a){$.ajax({type:"POST",url:l+g("/components/{0}/changeMedia",d.componentId),data:JSON.stringify(c),contentType:"application/json"}).then(function(c,b,d){a(c,b)})};var I=function(c,a){function b(a){return window.location.getParameter(a)}function d(a,b){a=window.location.getParameter(a);return null==a?b:0<=["true","on","1"].indexOf(String(a).toLowerCase())}window.location.getParameter||
(window.location.getParameter=function(a){if(!this.queryStringParams){for(var b={},c,d=/\+/g,g=/([^&=]+)=?([^&]*)/g,f=window.location.search.substring(1);c=g.exec(f);)b[decodeURIComponent(c[1].replace(d," "))]=decodeURIComponent(c[2].replace(d," "));this.queryStringParams=b}return this.queryStringParams[a]});window.oncontextmenu=function(a){return!1};$(document).ready(function(){var g=b("username")||null,f=b("password")||null,h=b("sound")||"true",k=b("audio_codec")||"opus+mka",l=b("encoding")||null,
m=b("action")||"connect",p=b("submit")||null,n=c.substring(7,c.indexOf("8080")-1),H=c.substring(c.indexOf("8080")),r=b("encryption")||null,x=b("key")||null,t=b("keyboard_layout")||null,q=b("start"),y=b("exit_with_children")||"",z=b("exit_with_client")||"",A=d("sharing",!1),B=d("video",!1),C=d("mediasource_video",!1),D=d("normal_fullscreen",!1),E=d("remote_logging",!0),u=d("debug",!1),F=d("insecure",!1),G=d("ignore_audio_blacklist",!1),v=d("clipboard",!0),e=new XpraClient("emulator-container");e.debug=
u;e.remote_logging=E;e.sharing=A;e.insecure=F;e.clipboard_enabled=v;B?(e.supported_encodings.push("h264"),C&&e.supported_encodings.push("vp8+webm","h264+mp4","mpeg4+mp4")):l&&"auto"!==l&&e.enable_encoding(l);m&&"connect"!=m&&(sns={mode:m},q&&(sns.start=[q]),y&&(sns["exit-with-children"]=!0),z&&(sns["exit-with-client"]=!0),e.start_new_session=sns);D&&(e.normal_fullscreen_mode=!0);h&&(e.audio_enabled=!0,console.log("sound enabled, audio codec string: "+k),k&&0<k.indexOf(":")&&(q=k.split(":"),e.audio_framework=
q[0],e.audio_codec=q[1]),e.audio_mediasource_enabled=d("mediasource",!0),e.audio_aurora_enabled=d("aurora",!0));t&&(e.keyboard_layout=t);g&&(e.username=g);f&&(e.authentication_key=f);r&&(e.encryption=r,x&&(e.encryption_key=x));u||(e.callback_close=function(a){if(p){var b="Connection closed (socket closed)";a&&(b=a);a="/connect.html?disconnect\x3d"+encodeURIComponent(b);var b={username:g,password:f,encoding:l,keyboard_layout:t,action:m,sound:h,audio_codec:k,clipboard:v,exit_with_children:y,exit_with_client:z,
sharing:A,normal_fullscreen:D,video:B,mediasource_video:C,debug:u,remote_logging:E,insecure:F,ignore_audio_blacklist:G},c;for(c in b){var d=b[c];d&&(a+="\x26"+c+"\x3d"+encodeURIComponent(d))}window.location=a}else window.location="connect.html"});e.init(G);r="https:"==document.location.protocol;XpraClient.prototype._do_connect=function(b){this.protocol=b&&!XPRA_CLIENT_FORCE_NO_WORKER?new XpraProtocolWorkerHost:new XpraProtocol;this.protocol.set_packet_handler(this._route_packet,this);b="ws://";this.ssl&&
(b="wss://");b+=this.host;b+=":"+this.port;this.protocol.open=function(b){var c=this;this.worker=new Worker(a+"/js/Protocol.js");this.worker.addEventListener("message",function(a){var d=a.data;switch(d.c){case "r":c.worker.postMessage({c:"o",u:b});break;case "p":c.packet_handler&&c.packet_handler(d.p,c.packet_ctx);break;case "l":console.log(d.t);break;default:console.error("got unknown command from worker"),console.error(a.data)}},!1)};this.protocol.open(b);var c=this;this.hello_timer=setTimeout(function(){c.disconnect_reason=
"Did not receive hello before timeout reached, not an Xpra server?";c.close()},this.HELLO_TIMEOUT)};XpraClient.prototype._get_desktop_size=function(){return[xpraShapes.xpraWidth,xpraShapes.xpraHeight]};XpraClient.prototype._get_DPI=function(){return xpraShapes.xpraDPI};e.connect=XpraClient.prototype.connect=function(b,c,d){console.log("connecting to xpra server "+b+":"+c+" with ssl: "+d);this.host=b;this.port=c;this.ssl=d;if(!this.encryption||this.encryption_key&&""!=this.encryption_key)if(window.Worker){console.log("we have webworker support");
var e=this;b=new Worker(a+"/js/lib/wsworker_check.js");b.addEventListener("message",function(a){switch(a.data.result){case !0:console.log("we can use websocket in webworker");e._do_connect(!0);break;case !1:console.log("we can't use websocket in webworker, won't use webworkers");e._do_connect(!1);break;default:console.log("client got unknown message from worker"),e._do_connect(!1)}},!1);b.postMessage({cmd:"check"})}else console.log("no webworker support at all.");else this.callback_close("no key specified for encryption")};
e._new_window=function(a,b,c,d,e,g,f,k){var w=document.createElement("div");w.id=String(a);var h=document.createElement("canvas");w.appendChild(h);document.getElementById("emulator-container").appendChild(w);h.width=d;h.height=e;b=new XpraWindow(this,h,a,b,c,d,e,g,f,k,this._window_geometry_changed,this._window_mouse_move,this._window_mouse_click,this._window_set_focus,this._window_closed);b.debug=this.debug;this.id_to_window[a]=b;f||(this.normal_fullscreen_mode&&"NORMAL"==b.windowtype&&(b.undecorate(),
b.set_maximized(!0)),f=b.get_internal_geometry(),this.protocol.send(["map-window",a,f.x,f.y,f.w,f.h,this._get_client_properties(b)]),this._window_set_focus(b));b.undecorate();b.ensure_visible();b.fill_screen();b.set_maximized(!0)};XpraWindow.prototype.getMouse=function(a){var b=a.clientX+jQuery(document).scrollLeft(),c=a.clientY+jQuery(document).scrollTop();isNaN(b)||isNaN(c)?isNaN(this.last_mouse_x)||isNaN(this.last_mouse_y)?c=b=0:(b=this.last_mouse_x,c=this.last_mouse_y):(this.last_mouse_x=b,this.last_mouse_y=
c);var d=0;"which"in a?d=Math.max(0,a.which):"button"in a&&(d=Math.max(0,a.button)+1);a=$("#emulator-container").offset();b-=a.left;c-=a.top;return{x:b,y:c,button:d}};e.connect(n,H,r);v&&(n=$("#pasteboard"),n.on("paste",function(a){a=(a.originalEvent||a).clipboardData.getData("text/plain");e.send_clipboard_token(unescape(encodeURIComponent(a)));return!1}),n.on("copy",function(a){a=e.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));$("#pasteboard").select();e.clipboard_pending=
!1;return!0}),n.on("cut",function(a){a=e.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));$("#pasteboard").select();e.clipboard_pending=!1;return!0}),$("#emulator-container").on("click",function(a){e.clipboard_pending&&(e.get_clipboard_buffer(),$("#pasteboard").text(e.clipboard_buffer),$("#pasteboard").select(),a=!0,window.clipboardData&&window.clipboardData.setData?clipboardData.setData("Text",this.clipboard_buffer):a=document.execCommand("copy"),a&&(e.clipboard_pending=
!1))}))})};this.startEnvironmentWithInternet=function(b,a,d){$.ajax({type:"POST",url:l+"/components",data:JSON.stringify({environment:b,keyboardLayout:a,keyboardModel:d}),contentType:"application/json"}).done(function(a){this.tmpdata=a;$.ajax({type:"POST",url:l+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).done(function(a){this.pollState(this.tmpdata.controlUrl.replace(/([^:])(\/\/+)/g,"$1/"),this.tmpdata.id)}.bind(this)).fail(function(a,
b,c){this._onError($.parseJSON(a.responseText))}.bind(this))}.bind(this)).fail(function(a,b,c){}.bind(this))}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(b,f,g){var h="on"+f;if(h in b){"__bwFlaEventHandlers__"in b||(b.constructor.prototype.__bwFlaEventHandlers__={});h in b.__bwFlaEventHandlers__||(b.__bwFlaEventHandlers__[h]=[]);var k=b.__bwFlaEventHandlers__[h];k.push(g);null==b[h]&&(b[h]=function(){var f=arguments;k.forEach(function(d){d.apply(b,f)})})}else console.error("Event "+f+" not supported!")};
BWFLA.unregisterEventCallback=function(b,f,g){"__bwFlaEventHandlers__"in b&&(b=b.__bwFlaEventHandlers__["on"+f],null!=b&&(g=b.indexOf(g),-1<g&&b.splice(g,1)))};
var BwflaMouse=function(b){function f(b){b=new Guacamole.Mouse.State(b.x,b.y,b.left,b.middle,b.right,b.up,b.down);h.push(b)}function g(){for(;0<h.length;)b.sendMouseState(h.shift());k=null;m=!1}var h=[],k=null,m=!1;this.onmousedown=function(b){null!=k&&window.clearTimeout(k);k=window.setTimeout(g,100);f(b);m=!0};this.onmouseup=function(b){null!=k&&window.clearTimeout(k);k=window.setTimeout(g,150);f(b);m=!0};this.onmousemove=function(d){1==m?f(d):b.sendMouseState(d)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(b,f){function g(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(b.requestPointerLock=b.requestPointerLock||b.mozRequestPointerLock||b.webkitRequestPointerLock,b.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===b||document.mozPointerLockElement===b||document.webkitPointerLockElement===b?(console.debug("Pointer was locked!"),b.isPointerLockEnabled=!0,b.removeEventListener(f,g,!1)):(console.debug("Pointer was unlocked."),b.isPointerLockEnabled=!1,b.addEventListener(f,g,!1))}function k(b){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",k,!1);document.addEventListener("mozpointerlockerror",k,!1);document.addEventListener("webkitpointerlockerror",k,!1);b.addEventListener(f,g,!1);b.isRelativeMouse=!0};BWFLA.hideClientCursor=function(b){b.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(b){b.getDisplay().showCursor(!0)};