var EaasClient=EaasClient||{};
EaasClient.Client=function(d,g){function e(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,c){return"undefined"!=typeof b[c]?b[c]:a})}function h(a){var b={};if(!a)return b;a.split("\x26").forEach(function(a){a=a.split("\x3d");b[a[0]]=decodeURIComponent(a[1])});return b}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraShapes={xpraWidth:640,xpraHeight:480,xpraDPI:96};this.setXpraShapes=function(a,b,c){xpraShapes={xpraWidth:a,xpraHeight:b,xpraDPI:c}};
var c=this,f=d.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.componentId=null;this.pollState=function(){$.get(f+e("/components/{0}/state",c.componentId)).then(function(a,b,l){a=a.state;"OK"==a?c.keepalive():"STOPPED"==a||"FAILED"==a?(c.keepalive(),$("#emulator-container").text("EMULATOR HAS STOPPED!")):"INACTIVE"==a?location.reload():c._onFatalError("Invalid component state: "+a)}).fail(function(){c._onFatalError("connection failed")})};
this._onFatalError=function(a){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"});console.error(a)};this._onResize=function(a,b){g.style.width=a;g.style.height=b;if(this.onResize)this.onResize(a,b)};this.keepalive=function(){var a=null;null!=c.networkId?a=e("/networks/{0}/keepalive",c.networkId):null!=c.componentId&&(a=e("/components/{0}/keepalive",c.componentId));$.post(f+a)};this.establishGuacamoleTunnel=
function(a){$.fn.focusWithoutScrolling=function(){var a=window.scrollX,b=window.scrollY;this.focus();window.scrollTo(a,b);return this};if(this.guac){var b=this.guac.getDisplay().getElement();$(b).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);g.insertBefore(a,g.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var b=new Guacamole.Mouse(a),
c=new Guacamole.Mouse.Touchpad(a),d=new BwflaMouse(this.guac);b.onmousedown=c.onmousedown=d.onmousedown;b.onmouseup=c.onmouseup=d.onmouseup;b.onmousemove=c.onmousemove=d.onmousemove;b=new Guacamole.Keyboard(a);b.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);b.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=
function(a,b){var l={type:"machine"};l.environment=a;"undefined"!==typeof b&&(l.keyboardLayout=b.keyboardLayout,l.keyboardModel=b.keyboardModel,l.object=b.object,null==b.object&&(l.software=b.software),l.userContext=b.userContext);var d=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(l),contentType:"application/json"}).then(function(b,l,m){console.log("Environment "+a+" started.");c.componentId=b.id;c.driveId=b.driveId;c.isStarted=
!0;c.pollStateIntervalId=setInterval(c.pollState,1500);d.resolve()},function(a){c._onFatalError($.parseJSON(a.responseText));d.reject()});return d.promise()};this.connect=function(){var a=$.Deferred();if(!this.isStarted)return c._onFatalError("Environment was not started properly!"),a.reject(),a.promise();console.log("Connecting viewer...");$.get(f+e("/components/{0}/controlurls",c.componentId)).done(function(b,l,d){if("undefined"!==typeof b.guacamole)l=b.guacamole,c.params=h(b.guacamole.substring(b.guacamole.indexOf("#")+
1)),b=c.establishGuacamoleTunnel;else if("undefined"!==typeof b.xpra)l=b.xpra,c.params=h(b.xpra.substring(b.xpra.indexOf("#")+1)),b=c.prepareAndLoadXpra;else if("undefined"!==typeof b.webemulator)l=encodeURIComponent(JSON.stringify(b)),c.params=h(b.webemulator.substring(b.webemulator.indexOf("#")+1)),b=c.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+b);a.reject();return}b.call(c,l);console.log("Viewer connected successfully.");c.isConnected=!0;a.resolve()}).fail(function(b){console.error("Connecting viewer failed!");
c._onFatalError($.parseJSON(b.responseText));a.reject()});return a.promise()};this.disconnect=function(){var a=$.Deferred();if(!this.isConnected)return a.reject(),a.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");this.isConnected=!1;a.resolve();return a.promise()};this.checkpoint=function(){var a=$.Deferred();if(!this.isStarted)return c._onFatalError("Environment was not started properly!"),a.reject(),a.promise();
console.log("Checkpointing session...");$.ajax({type:"POST",url:f+e("/components/{0}/checkpoint",c.componentId),timeout:3E4}).done(function(b,c,d){b=b.environment_id;console.log("Checkpoint created: "+b);a.resolve(b)}).fail(function(b,c,d){b=$.parseJSON(b.responseText);null!==b.message&&console.error("Server-Error:"+b.message);null!==d&&console.error("Ajax-Error: "+d);console.error("Checkpointing failed!");a.reject()});return a.promise()};this.getScreenshotUrl=function(){return f+e("/components/{0}/screenshot",
c.componentId)};this.getPrintUrl=function(){return f+e("/components/{0}/print",c.componentId)};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:f+e("/components/{0}/stop",c.componentId),async:!1}),this.isStarted=!1,$(g).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){for(var a=this.disconnect();"pending"===a.state(););this.stopEnvironment();this.clearTimer()};
this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(a,b){$.ajax({type:"POST",url:f+e("/components/{0}/snapshot",c.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(a,c,d){b(a,c)})};this.changeMedia=function(a,b){$.ajax({type:"POST",url:f+e("/components/{0}/changeMedia",c.componentId),
data:JSON.stringify(a),contentType:"application/json"}).then(function(a,c,d){b(a,c)})};this.prepareAndLoadXpra=function(a){var b=document.getElementsByTagName("script"),d;for(d in b){var e="eaas-client.js";if("undefined"!=typeof b[d].src&&-1!=b[d].src.indexOf(e))var f=b[d].src}var k=f.substring(0,f.indexOf(e))+"xpra/";$.when($.getScript(k+"/eaas-xpra.js"),$.getScript(k+"/js/lib/jquery-ui.js"),$.getScript(k+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(k+"/js/lib/bencode.js"),$.getScript(k+
"/js/lib/zlib.js"),$.getScript(k+"/js/lib/lz4.js"),$.getScript(k+"/js/lib/forge.js"),$.getScript(k+"/js/lib/broadway/Decoder.js"),$.getScript(k+"/js/lib/aurora/aurora-xpra.js"),$.getScript(k+"/js/Utilities.js"),$.getScript(k+"/js/Keycodes.js"),$.getScript(k+"/js/Notifications.js"),$.getScript(k+"/js/MediaSourceUtil.js"),$.getScript(k+"/js/Window.js"),$.getScript(k+"/js/Protocol.js"),$.getScript(k+"/js/Client.js"),$.getScript(k+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){loadXpra(a,
k,c.xpraShapes)})};this.prepareAndLoadWebEmulator=function(a){var b=document.getElementsByTagName("script"),c;for(c in b){var d="eaas-client.js";if("undefined"!=typeof b[c].src&&-1!=b[c].src.indexOf(d))var e=b[c].src}b=e.substring(0,e.indexOf(d))+"webemulator/";c=document.createElement("iframe");c.setAttribute("style","width: 100%; height: 600px;");c.src=b+"#controlurls\x3d"+a;g.appendChild(c)};this.startEnvironmentWithInternet=function(a,b){var d={type:"machine"};d.environment=a;"undefined"!==typeof b&&
(d.keyboardLayout=b.keyboardLayout,d.keyboardModel=b.keyboardModel,d.object=b.object,null==b.object&&(d.software=b.software),d.userContext=b.userContext);var e=$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(b,d,l){console.log("Environment "+a+" started.");$.ajax({type:"POST",url:f+"/networks",data:JSON.stringify({components:[{componentId:b.id}],hasInternet:!0}),contentType:"application/json"}).then(function(a,
d,f){c.componentId=b.id;c.driveId=b.driveId;c.networkId=a.id;c.isStarted=!0;c.pollStateIntervalId=setInterval(c.pollState,1500);e.resolve()})},function(a){c._onFatalError($.parseJSON(xhr.responseText));e.reject()});return e.promise()};this.startConnectedEnvironments=function(a,b,d){var e={type:"machine"};e.environment=a;"undefined"!==typeof d&&(e.keyboardLayout=d.keyboardLayout,e.keyboardModel=d.keyboardModel,e.object=d.object,null==d.object&&(e.software=d.software),e.userContext=d.userContext);var g=
$.Deferred();console.log("Starting environment "+a+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(d,h,l){console.log("Environment "+a+" started.");e.environment=b;$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(a,b,e){$.ajax({type:"POST",url:f+"/networks",data:JSON.stringify({components:[{componentId:d.id},{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(a,
b,e){c.componentId=d.id;c.driveId=d.driveId;c.networkId=a.id;c.isStarted=!0;c.pollStateIntervalId=setInterval(c.pollState,1500);g.resolve()})})},function(a){c._onFatalError($.parseJSON(xhr.responseText));g.reject()});return g.promise()}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(d,g,e){var h="on"+g;if(h in d){"__bwFlaEventHandlers__"in d||(d.constructor.prototype.__bwFlaEventHandlers__={});h in d.__bwFlaEventHandlers__||(d.__bwFlaEventHandlers__[h]=[]);var c=d.__bwFlaEventHandlers__[h];c.push(e);null==d[h]&&(d[h]=function(){var e=arguments;c.forEach(function(a){a.apply(d,e)})})}else console.error("Event "+g+" not supported!")};
BWFLA.unregisterEventCallback=function(d,g,e){"__bwFlaEventHandlers__"in d&&(d=d.__bwFlaEventHandlers__["on"+g],null!=d&&(e=d.indexOf(e),-1<e&&d.splice(e,1)))};
var BwflaMouse=function(d){function g(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function e(){for(;0<h.length;)d.sendMouseState(h.shift());c=null;f=!1}var h=[],c=null,f=!1;this.onmousedown=function(a){null!=c&&window.clearTimeout(c);c=window.setTimeout(e,100);g(a);f=!0};this.onmouseup=function(a){null!=c&&window.clearTimeout(c);c=window.setTimeout(e,150);g(a);f=!0};this.onmousemove=function(a){1==f?g(a):d.sendMouseState(a)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(d,g){function e(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(d.requestPointerLock=d.requestPointerLock||d.mozRequestPointerLock||d.webkitRequestPointerLock,d.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===d||document.mozPointerLockElement===d||document.webkitPointerLockElement===d?(console.debug("Pointer was locked!"),d.isPointerLockEnabled=!0,d.removeEventListener(g,e,!1)):(console.debug("Pointer was unlocked."),d.isPointerLockEnabled=!1,d.addEventListener(g,e,!1))}function c(c){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);document.addEventListener("webkitpointerlockerror",c,!1);d.addEventListener(g,e,!1);d.isRelativeMouse=!0};BWFLA.hideClientCursor=function(d){d.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(d){d.getDisplay().showCursor(!0)};