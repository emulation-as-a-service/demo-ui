var EaasClient=EaasClient||{};
EaasClient.Client=function(a,d){function c(a){var b=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,k){return"undefined"!=typeof b[k]?b[k]:a})}function f(a){var b={};if(!a)return b;a.split("\x26").forEach(function(a){a=a.split("\x3d");b[a[0]]=decodeURIComponent(a[1])});return b}var b=this,g=a.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.params=this.driveId=this.networkId=this.componentId=null;var e=!1;this.pollState=function(a){$.get(g+c("/components/{0}/state",
b.componentId)).then(function(a,k,d){b.guac||$.get(g+c("/components/{0}/controlurls",b.componentId)).then(function(a,k,l){b.params=f(a.guacamole.substring(a.guacamole.indexOf("#")+1));b.establishGuacamoleTunnel(a.guacamole);b.keepaliveIntervalId=setInterval(b.keepalive,1E3);e=!0;for(a=0;a<h.length;a++)if(h[a])h[a]()})},function(a){b._onError($.parseJSON(a.responseText))})};var h=[];this.addOnConnectListener=function(a){if(e)return a(),{remove:function(){}};var b=h.push(a)-1;return{remove:function(){delete h[b]}}};
this._onError=function(a){this.keepaliveIntervalId&&clearInterval(this.keepaliveIntervalId);this.guac&&this.guac.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"})};this._onResize=function(a,b){d.style.width=a;d.style.height=b;if(this.onResize)this.onResize(a,b)};this.keepalive=function(){var a=null;null!=b.networkId?a=c("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&(a=c("/components/{0}/keepalive",b.componentId));$.post(g+a)};this.establishGuacamoleTunnel=
function(a){window.onbeforeunload=function(){this.guac.disconnect()}.bind(this);$.fn.focusWithoutScrolling=function(){var a=window.scrollX,b=window.scrollY;this.focus();window.scrollTo(a,b);return this};this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);d.insertBefore(a,d.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var b=new Guacamole.Mouse(a),
e=new Guacamole.Mouse.Touchpad(a),c=new BwflaMouse(this.guac);b.onmousedown=e.onmousedown=c.onmousedown;b.onmouseup=e.onmouseup=c.onmouseup;b.onmousemove=e.onmousemove=c.onmousemove;b=new Guacamole.Keyboard(a);b.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);b.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=
function(a,e){var c={type:"machine"};c.environment=a;"undefined"!==typeof e&&(c.keyboardLayout=e.keyboardLayout,c.keyboardModel=e.keyboardModel,c.object=e.object,null==e.object&&(c.software=e.software));$.ajax({type:"POST",url:g+"/components",data:JSON.stringify(c),contentType:"application/json"}).then(function(a,e,c){b.componentId=a.id;b.driveId=a.driveId;b.pollState()},function(a){b._onError($.parseJSON(a.responseText))})};this.getScreenshotUrl=function(){return g+c("/components/{0}/screenshot",
b.componentId)};this.stopEnvironment=function(){this.guac.disconnect();$(d).empty()};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};this.startEnvironmentWithInternet=function(a,b,e){$.ajax({type:"POST",url:g+"/components",data:JSON.stringify({environment:a,keyboardLayout:b,keyboardModel:e}),contentType:"application/json"}).done(function(a){this.tmpdata=a;$.ajax({type:"POST",url:g+"/networks",data:JSON.stringify({components:[{componentId:a.id}],
hasInternet:!0}),contentType:"application/json"}).done(function(a){this.pollState(this.tmpdata.controlUrl.replace(/([^:])(\/\/+)/g,"$1/"),this.tmpdata.id)}.bind(this)).fail(function(a,b,e){this._onError($.parseJSON(a.responseText))}.bind(this))}.bind(this)).fail(function(a,b,e){}.bind(this))}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,d,c){var f="on"+d;if(f in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});f in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[f]=[]);var b=a.__bwFlaEventHandlers__[f];b.push(c);null==a[f]&&(a[f]=function(){var c=arguments;b.forEach(function(b){b.apply(a,c)})})}else console.error("Event "+d+" not supported!")};
BWFLA.unregisterEventCallback=function(a,d,c){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+d],null!=a&&(c=a.indexOf(c),-1<c&&a.splice(c,1)))};
var BwflaMouse=function(a){function d(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);f.push(a)}function c(){for(;0<f.length;)a.sendMouseState(f.shift());b=null;g=!1}var f=[],b=null,g=!1;this.onmousedown=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(c,100);d(a);g=!0};this.onmouseup=function(a){null!=b&&window.clearTimeout(b);b=window.setTimeout(c,150);d(a);g=!0};this.onmousemove=function(b){1==g?d(b):a.sendMouseState(b)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,d){function c(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function f(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(d,c,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(d,c,!1))}function b(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",f,!1);document.addEventListener("mozpointerlockchange",f,!1);document.addEventListener("webkitpointerlockchange",
f,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);a.addEventListener(d,c,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};