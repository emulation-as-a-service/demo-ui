var EaasClient=EaasClient||{};
EaasClient.Client=function(a,f){function g(a){var c=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,n){return"undefined"!=typeof c[n]?c[n]:a})}function h(a){var c={};if(!a)return c;a.split("\x26").forEach(function(a){a=a.split("\x3d");c[a[0]]=decodeURIComponent(a[1])})}function l(a){var c=document.getElementsByTagName("script"),n;for(n in c){var p="eaas-client.js";if("undefined"!=typeof c[n].src&&-1!=c[n].src.indexOf(p))var y=c[n].src}var k=y.substring(0,y.indexOf(p))+
"xpra/";$.when($.getScript(k+"/js/lib/jquery-ui.js"),$.getScript(k+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(k+"/js/lib/bencode.js"),$.getScript(k+"/js/lib/zlib.js"),$.getScript(k+"/js/lib/lz4.js"),$.getScript(k+"/js/lib/forge.js"),$.getScript(k+"/js/lib/broadway/Decoder.js"),$.getScript(k+"/js/lib/aurora/aurora-xpra.js"),$.getScript(k+"/js/Utilities.js"),$.getScript(k+"/js/Keycodes.js"),$.getScript(k+"/js/Notifications.js"),$.getScript(k+"/js/MediaSourceUtil.js"),$.getScript(k+"/js/Window.js"),
$.getScript(k+"/js/Protocol.js"),$.getScript(k+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){I(a,k)})}xpraShapes={xpraWidth:1024,xpraHeight:768,xpraDPI:96};this.setXpraShapes=function(a,c,e){xpraShapes={xpraWidth:a,xpraHeight:c,xpraDPI:e}};var b=this,m=a.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.params=this.driveId=this.networkId=this.componentId=null;var r=!1;this.pollState=function(a){$.get(m+g("/components/{0}/state",b.componentId)).then(function(a,n,p){b.guac||
$.get(m+g("/components/{0}/controlurls",b.componentId)).then(function(a,n,c){xpra="xpra";-1<a.xpra.indexOf(xpra)?(console.log("my link"+a.xpra),b.keepaliveIntervalId=setInterval(b.keepalive,1E3),l(a.xpra)):(b.params=h(a.guacamole.substring(a.guacamole.indexOf("#")+1)),b.establishGuacamoleTunnel(a.guacamole),b.keepaliveIntervalId=setInterval(b.keepalive,1E3));r=!0;for(a=0;a<q.length;a++)if(q[a])q[a]()})},function(a){b._onError($.parseJSON(a.responseText))})};var q=[];this.addOnConnectListener=function(a){console.log("hasConnected, after"+
r);if(r)return a(),{remove:function(){}};var n=q.push(a)-1;return{remove:function(){delete q[n]}}};this._onError=function(a){this.keepaliveIntervalId&&clearInterval(this.keepaliveIntervalId);this.guac&&this.guac.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"})};this._onResize=function(a,c){f.style.width=a;f.style.height=c;if(this.onResize)this.onResize(a,c)};this.keepalive=function(){var a=null;null!=b.networkId?a=g("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&
(a=g("/components/{0}/keepalive",b.componentId));$.post(m+a)};this.establishGuacamoleTunnel=function(a){window.onbeforeunload=function(){this.guac.disconnect()}.bind(this);$.fn.focusWithoutScrolling=function(){var a=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(a,c);return this};this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);f.insertBefore(a,f.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),
"resize",this._onResize.bind(this));this.guac.connect();var c=new Guacamole.Mouse(a),e=new Guacamole.Mouse.Touchpad(a),p=new BwflaMouse(this.guac);c.onmousedown=e.onmousedown=p.onmousedown;c.onmouseup=e.onmouseup=p.onmouseup;c.onmousemove=e.onmousemove=p.onmousemove;c=new Guacamole.Keyboard(a);c.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);c.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});
if(this.onReady)this.onReady()};this.startEnvironment=function(a,c){var e={type:"machine"};e.environment=a;"undefined"!==typeof c&&(e.keyboardLayout=c.keyboardLayout,e.keyboardModel=c.keyboardModel,e.object=c.object,null==c.object&&(e.software=c.software));$.ajax({type:"POST",url:m+"/components",data:JSON.stringify(e),contentType:"application/json"}).then(function(a,c,e){b.componentId=a.id;b.driveId=a.driveId;b.pollState()},function(a){b._onError($.parseJSON(a.responseText))})};this.getScreenshotUrl=
function(){return m+g("/components/{0}/screenshot",b.componentId)};this.stopEnvironment=function(){this.guac.disconnect();$(f).empty()};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};var I=function(a,c){function e(a){return window.location.getParameter(a)}function b(a,b){a=window.location.getParameter(a);return null==a?b:0<=["true","on","1"].indexOf(String(a).toLowerCase())}window.location.getParameter||(window.location.getParameter=
function(a){if(!this.queryStringParams){for(var b={},c,e=/\+/g,m=/([^&=]+)=?([^&]*)/g,g=window.location.search.substring(1);c=m.exec(g);)b[decodeURIComponent(c[1].replace(e," "))]=decodeURIComponent(c[2].replace(e," "));this.queryStringParams=b}return this.queryStringParams[a]});window.oncontextmenu=function(a){return!1};$(document).ready(function(){var m=e("username")||null,k=e("password")||null,g=e("sound")||"true",f=e("audio_codec")||"opus+mka",h=e("encoding")||null,l=e("action")||"connect",n=
e("submit")||null,p=a.substring(7,a.indexOf("8080")-1),q=a.substring(a.indexOf("8080")),u=e("encryption")||null,r=e("key")||null,v=e("keyboard_layout")||null,t=e("start"),z=e("exit_with_children")||"",A=e("exit_with_client")||"",B=b("sharing",!1),C=b("video",!1),D=b("mediasource_video",!1),E=b("normal_fullscreen",!1),F=b("remote_logging",!0),w=b("debug",!1),G=b("insecure",!1),H=b("ignore_audio_blacklist",!1),x=b("clipboard",!0),d=new XpraClient("display");d.debug=w;d.remote_logging=F;d.sharing=B;
d.insecure=G;d.clipboard_enabled=x;C?(d.supported_encodings.push("h264"),D&&d.supported_encodings.push("vp8+webm","h264+mp4","mpeg4+mp4")):h&&"auto"!==h&&d.enable_encoding(h);l&&"connect"!=l&&(sns={mode:l},t&&(sns.start=[t]),z&&(sns["exit-with-children"]=!0),A&&(sns["exit-with-client"]=!0),d.start_new_session=sns);E&&(d.normal_fullscreen_mode=!0);g&&(d.audio_enabled=!0,console.log("sound enabled, audio codec string: "+f),f&&0<f.indexOf(":")&&(t=f.split(":"),d.audio_framework=t[0],d.audio_codec=t[1]),
d.audio_mediasource_enabled=b("mediasource",!0),d.audio_aurora_enabled=b("aurora",!0));v&&(d.keyboard_layout=v);m&&(d.username=m);k&&(d.authentication_key=k);u&&(d.encryption=u,r&&(d.encryption_key=r));w||(d.callback_close=function(a){if(n){var b="Connection closed (socket closed)";a&&(b=a);a="/connect.html?disconnect\x3d"+encodeURIComponent(b);var b={username:m,password:k,encoding:h,keyboard_layout:v,action:l,sound:g,audio_codec:f,clipboard:x,exit_with_children:z,exit_with_client:A,sharing:B,normal_fullscreen:E,
video:C,mediasource_video:D,debug:w,remote_logging:F,insecure:G,ignore_audio_blacklist:H},c;for(c in b){var d=b[c];d&&(a+="\x26"+c+"\x3d"+encodeURIComponent(d))}window.location=a}else window.location="connect.html"});d.init(H);u="https:"==document.location.protocol;XpraClient.prototype._do_connect=function(a){this.protocol=a&&!XPRA_CLIENT_FORCE_NO_WORKER?new XpraProtocolWorkerHost:new XpraProtocol;this.protocol.set_packet_handler(this._route_packet,this);a="ws://";this.ssl&&(a="wss://");a+=this.host;
a+=":"+this.port;this.protocol.open=function(a){var b=this;this.worker=new Worker(c+"/js/Protocol.js");this.worker.addEventListener("message",function(c){var d=c.data;switch(d.c){case "r":b.worker.postMessage({c:"o",u:a});break;case "p":b.packet_handler&&b.packet_handler(d.p,b.packet_ctx);break;case "l":console.log(d.t);break;default:console.error("got unknown command from worker"),console.error(c.data)}},!1)};this.protocol.open(a);var b=this;this.hello_timer=setTimeout(function(){b.disconnect_reason=
"Did not receive hello before timeout reached, not an Xpra server?";b.close()},this.HELLO_TIMEOUT)};XpraClient.prototype._get_desktop_size=function(){return[xpraShapes.xpraWidth,xpraShapes.xpraHeight]};XpraClient.prototype._get_DPI=function(){return xpraShapes.xpraDPI};d.connect=XpraClient.prototype.connect=function(a,b,d){console.log("connecting to xpra server "+a+":"+b+" with ssl: "+d);this.host=a;this.port=b;this.ssl=d;if(!this.encryption||this.encryption_key&&""!=this.encryption_key)if(window.Worker){console.log("we have webworker support");
var e=this;a=new Worker(c+"/js/lib/wsworker_check.js");a.addEventListener("message",function(a){switch(a.data.result){case !0:console.log("we can use websocket in webworker");e._do_connect(!0);break;case !1:console.log("we can't use websocket in webworker, won't use webworkers");e._do_connect(!1);break;default:console.log("client got unknown message from worker"),e._do_connect(!1)}},!1);a.postMessage({cmd:"check"})}else console.log("no webworker support at all.");else this.callback_close("no key specified for encryption")};
d._new_window=function(a,b,c,d,e,m,f,g){var k=document.createElement("div");k.id=String(a);var h=document.createElement("canvas");k.appendChild(h);document.getElementById("display").appendChild(k);h.width=d;h.height=e;b=new XpraWindow(this,h,a,b,c,d,e,m,f,g,this._window_geometry_changed,this._window_mouse_move,this._window_mouse_click,this._window_set_focus,this._window_closed);b.debug=this.debug;this.id_to_window[a]=b;f||(this.normal_fullscreen_mode&&"NORMAL"==b.windowtype&&(b.undecorate(),b.set_maximized(!0)),
f=b.get_internal_geometry(),this.protocol.send(["map-window",a,f.x,f.y,f.w,f.h,this._get_client_properties(b)]),this._window_set_focus(b));b.undecorate();b.ensure_visible();b.fill_screen();b.set_maximized(!0)};d.connect(p,q,u);x&&(p=$("#pasteboard"),p.on("paste",function(a){a=(a.originalEvent||a).clipboardData.getData("text/plain");d.send_clipboard_token(unescape(encodeURIComponent(a)));return!1}),p.on("copy",function(a){a=d.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));
$("#pasteboard").select();d.clipboard_pending=!1;return!0}),p.on("cut",function(a){a=d.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));$("#pasteboard").select();d.clipboard_pending=!1;return!0}),$("#display").on("click",function(a){d.clipboard_pending&&(d.get_clipboard_buffer(),$("#pasteboard").text(d.clipboard_buffer),$("#pasteboard").select(),a=!0,window.clipboardData&&window.clipboardData.setData?clipboardData.setData("Text",this.clipboard_buffer):a=document.execCommand("copy"),
a&&(d.clipboard_pending=!1))}))})};this.startEnvironmentWithInternet=function(a,b,e){$.ajax({type:"POST",url:m+"/components",data:JSON.stringify({environment:a,keyboardLayout:b,keyboardModel:e}),contentType:"application/json"}).done(function(a){this.tmpdata=a;$.ajax({type:"POST",url:m+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).done(function(a){this.pollState(this.tmpdata.controlUrl.replace(/([^:])(\/\/+)/g,"$1/"),this.tmpdata.id)}.bind(this)).fail(function(a,
b,c){this._onError($.parseJSON(a.responseText))}.bind(this))}.bind(this)).fail(function(a,b,c){}.bind(this))}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,f,g){var h="on"+f;if(h in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});h in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[h]=[]);var l=a.__bwFlaEventHandlers__[h];l.push(g);null==a[h]&&(a[h]=function(){var b=arguments;l.forEach(function(m){m.apply(a,b)})})}else console.error("Event "+f+" not supported!")};
BWFLA.unregisterEventCallback=function(a,f,g){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+f],null!=a&&(g=a.indexOf(g),-1<g&&a.splice(g,1)))};
var BwflaMouse=function(a){function f(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function g(){for(;0<h.length;)a.sendMouseState(h.shift());l=null;b=!1}var h=[],l=null,b=!1;this.onmousedown=function(a){null!=l&&window.clearTimeout(l);l=window.setTimeout(g,100);f(a);b=!0};this.onmouseup=function(a){null!=l&&window.clearTimeout(l);l=window.setTimeout(g,150);f(a);b=!0};this.onmousemove=function(g){1==b?f(g):a.sendMouseState(g)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,f){function g(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(f,g,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(f,g,!1))}function l(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",l,!1);document.addEventListener("mozpointerlockerror",l,!1);document.addEventListener("webkitpointerlockerror",l,!1);a.addEventListener(f,g,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};