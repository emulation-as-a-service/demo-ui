var EaasClient=EaasClient||{};
EaasClient.Client=function(c,g){function e(d){var a=Array.prototype.slice.call(arguments,1);return d.replace(/{(\d+)}/g,function(d,b){return"undefined"!=typeof a[b]?a[b]:d})}function k(d){var a={};if(!d)return a;d.split("\x26").forEach(function(d){d=d.split("\x3d");a[d[0]]=decodeURIComponent(d[1])});return a}window.onbeforeunload=function(){this.release()}.bind(this);this.xpraShapes={xpraWidth:640,xpraHeight:480,xpraDPI:96};this.setXpraShapes=function(d,a,b){xpraShapes={xpraWidth:d,xpraHeight:a,xpraDPI:b}};
var b=this,h=c.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.params=this.driveId=this.networkId=this.componentId=null;var f;this.pollState=function(){$.get(h+e("/components/{0}/state",b.componentId)).then(function(d,a,m){f=d.state;if("OK"==f)b.keepalive();else if("STOPPED"==f||"FAILED"==f){if(b.keepalive(),this.onEmulatorStopped)this.onEmulatorStopped()}else"INACTIVE"==f?location.reload():b._onFatalError("Invalid component state: "+this.emulatorState)}).fail(function(){b._onFatalError("connection failed")})};
this._onFatalError=function(d){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(d||{error:"No error message specified"});console.error(d)};this._onResize=function(d,a){g.style.width=d;g.style.height=a;if(this.onResize)this.onResize(d,a)};this.keepalive=function(){var d=null;null!=b.networkId?d=e("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&(d=e("/components/{0}/keepalive",b.componentId));$.post(h+d)};this.establishGuacamoleTunnel=
function(d){$.fn.focusWithoutScrolling=function(){var a=window.scrollX,d=window.scrollY;this.focus();window.scrollTo(a,d);return this};if(this.guac){var a=this.guac.getDisplay().getElement();$(a).remove()}this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(d.split("#")[0]));d=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);g.insertBefore(d,g.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var a=new Guacamole.Mouse(d),
b=new Guacamole.Mouse.Touchpad(d),c=new BwflaMouse(this.guac);a.onmousedown=b.onmousedown=c.onmousedown;a.onmouseup=b.onmouseup=c.onmouseup;a.onmousemove=b.onmousemove=c.onmousemove;a=new Guacamole.Keyboard(d);a.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);a.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(d).attr("tabindex","0");$(d).css("outline","0");$(d).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=
function(d,a){var m={type:"machine"};m.environment=d;"undefined"!==typeof a&&(m.keyboardLayout=a.keyboardLayout,m.keyboardModel=a.keyboardModel,m.object=a.object,null==a.object&&(m.software=a.software),m.userContext=a.userContext);var c=$.Deferred();console.log("Starting environment "+d+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(m),contentType:"application/json"}).then(function(a,m,n){console.log("Environment "+d+" started.");b.componentId=a.id;b.driveId=a.driveId;b.isStarted=
!0;b.pollStateIntervalId=setInterval(b.pollState,1500);c.resolve()},function(a){b._onFatalError($.parseJSON(a.responseText));c.reject()});return c.promise()};this.connect=function(){var d=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),d.reject(),d.promise();console.log("Connecting viewer...");$.get(h+e("/components/{0}/controlurls",b.componentId)).done(function(a,m,c){if("undefined"!==typeof a.guacamole)m=a.guacamole,b.params=k(a.guacamole.substring(a.guacamole.indexOf("#")+
1)),a=b.establishGuacamoleTunnel;else if("undefined"!==typeof a.xpra)m=a.xpra,b.params=k(a.xpra.substring(a.xpra.indexOf("#")+1)),a=b.prepareAndLoadXpra;else if("undefined"!==typeof a.webemulator)m=encodeURIComponent(JSON.stringify(a)),b.params=k(a.webemulator.substring(a.webemulator.indexOf("#")+1)),a=b.prepareAndLoadWebEmulator;else{console.error("Unsupported connector type: "+a);d.reject();return}a.call(b,m);console.log("Viewer connected successfully.");b.isConnected=!0;d.resolve()}).fail(function(a){console.error("Connecting viewer failed!");
b._onFatalError($.parseJSON(a.responseText));d.reject()});return d.promise()};this.disconnect=function(){var d=$.Deferred();if(!this.isConnected)return d.reject(),d.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");this.isConnected=!1;d.resolve();return d.promise()};this.checkpoint=function(){var d=$.Deferred();if(!this.isStarted)return b._onFatalError("Environment was not started properly!"),d.reject(),d.promise();
console.log("Checkpointing session...");$.ajax({type:"POST",url:h+e("/components/{0}/checkpoint",b.componentId),timeout:3E4}).done(function(a,b,c){a=a.environment_id;console.log("Checkpoint created: "+a);d.resolve(a)}).fail(function(a,b,c){a=$.parseJSON(a.responseText);null!==a.message&&console.error("Server-Error:"+a.message);null!==c&&console.error("Ajax-Error: "+c);console.error("Checkpointing failed!");d.reject()});return d.promise()};this.getScreenshotUrl=function(){return h+e("/components/{0}/screenshot",
b.componentId)};this.getPrintUrl=function(){return h+e("/components/{0}/print",b.componentId)};this.getEmulatorState=function(){if("undefined"!==typeof f)return f;console.warn("emulator state is not defined yet!");return"undefined"};this.stopEnvironment=function(){this.isStarted&&(this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId),$.ajax({type:"GET",url:h+e("/components/{0}/stop",b.componentId),async:!1}),this.isStarted=!1,$(g).empty())};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};
this.release=function(){for(var d=this.disconnect();"pending"===d.state(););this.stopEnvironment();this.clearTimer()};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(d,a,c){$.ajax({type:"POST",url:h+e("/components/{0}/snapshot",b.componentId),data:JSON.stringify(d),contentType:"application/json"}).then(function(d,
b,c){a(d,b)}).fail(function(a,d,b){c?c(b):(console.log(a.statusText),console.log(d),console.log(b))})};this.changeMedia=function(d,a){$.ajax({type:"POST",url:h+e("/components/{0}/changeMedia",b.componentId),data:JSON.stringify(d),contentType:"application/json"}).then(function(d,b,c){a(d,b)})};this.prepareAndLoadXpra=function(d){var a=document.getElementsByTagName("script"),c;for(c in a){var f="eaas-client.js";if("undefined"!=typeof a[c].src&&-1!=a[c].src.indexOf(f))var e=a[c].src}var l=e.substring(0,
e.indexOf(f))+"xpra/";$.when($.getScript(l+"/eaas-xpra.js"),$.getScript(l+"/js/lib/jquery-ui.js"),$.getScript(l+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(l+"/js/lib/bencode.js"),$.getScript(l+"/js/lib/zlib.js"),$.getScript(l+"/js/lib/lz4.js"),$.getScript(l+"/js/lib/forge.js"),$.getScript(l+"/js/lib/broadway/Decoder.js"),$.getScript(l+"/js/lib/aurora/aurora-xpra.js"),$.getScript(l+"/js/Utilities.js"),$.getScript(l+"/js/Keycodes.js"),$.getScript(l+"/js/Notifications.js"),$.getScript(l+"/js/MediaSourceUtil.js"),
$.getScript(l+"/js/Window.js"),$.getScript(l+"/js/Protocol.js"),$.getScript(l+"/js/Client.js"),$.getScript(l+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){loadXpra(d,l,b.xpraShapes)})};this.prepareAndLoadWebEmulator=function(d){var a=document.getElementsByTagName("script"),b;for(b in a){var c="eaas-client.js";if("undefined"!=typeof a[b].src&&-1!=a[b].src.indexOf(c))var f=a[b].src}a=f.substring(0,f.indexOf(c))+"webemulator/";b=document.createElement("iframe");b.setAttribute("style",
"width: 100%; height: 600px;");b.src=a+"#controlurls\x3d"+d;g.appendChild(b)};this.startEnvironmentWithInternet=function(d,a){var c={type:"machine"};c.environment=d;"undefined"!==typeof a&&(c.keyboardLayout=a.keyboardLayout,c.keyboardModel=a.keyboardModel,c.object=a.object,null==a.object&&(c.software=a.software),c.userContext=a.userContext);var f=$.Deferred();console.log("Starting environment "+d+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(c),contentType:"application/json"}).then(function(a,
c,e){console.log("Environment "+d+" started.");$.ajax({type:"POST",url:h+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(d,c,e){b.componentId=a.id;b.driveId=a.driveId;b.networkId=d.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);f.resolve()})},function(a){b._onFatalError($.parseJSON(xhr.responseText));f.reject()});return f.promise()};this.startConnectedEnvironments=function(d,a,c){var f={type:"machine"};
f.environment=d;"undefined"!==typeof c&&(f.keyboardLayout=c.keyboardLayout,f.keyboardModel=c.keyboardModel,f.object=c.object,null==c.object&&(f.software=c.software),f.userContext=c.userContext);var e=$.Deferred();console.log("Starting environment "+d+"...");$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(f),contentType:"application/json"}).then(function(c,g,k){console.log("Environment "+d+" started.");f.environment=a;$.ajax({type:"POST",url:h+"/components",data:JSON.stringify(f),contentType:"application/json"}).then(function(a,
d,f){$.ajax({type:"POST",url:h+"/networks",data:JSON.stringify({components:[{componentId:c.id},{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).then(function(a,d,f){b.componentId=c.id;b.driveId=c.driveId;b.networkId=a.id;b.isStarted=!0;b.pollStateIntervalId=setInterval(b.pollState,1500);e.resolve()})})},function(a){b._onFatalError($.parseJSON(xhr.responseText));e.reject()});return e.promise()}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(c,g,e){var k="on"+g;if(k in c){"__bwFlaEventHandlers__"in c||(c.constructor.prototype.__bwFlaEventHandlers__={});k in c.__bwFlaEventHandlers__||(c.__bwFlaEventHandlers__[k]=[]);var b=c.__bwFlaEventHandlers__[k];b.push(e);null==c[k]&&(c[k]=function(){var e=arguments;b.forEach(function(b){b.apply(c,e)})})}else console.error("Event "+g+" not supported!")};
BWFLA.unregisterEventCallback=function(c,g,e){"__bwFlaEventHandlers__"in c&&(c=c.__bwFlaEventHandlers__["on"+g],null!=c&&(e=c.indexOf(e),-1<e&&c.splice(e,1)))};
var BwflaMouse=function(c){function g(b){b=new Guacamole.Mouse.State(b.x,b.y,b.left,b.middle,b.right,b.up,b.down);k.push(b)}function e(){for(;0<k.length;)c.sendMouseState(k.shift());b=null;h=!1}var k=[],b=null,h=!1;this.onmousedown=function(c){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,100);g(c);h=!0};this.onmouseup=function(c){null!=b&&window.clearTimeout(b);b=window.setTimeout(e,150);g(c);h=!0};this.onmousemove=function(b){1==h?g(b):c.sendMouseState(b)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(c,g){function e(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(c.requestPointerLock=c.requestPointerLock||c.mozRequestPointerLock||c.webkitRequestPointerLock,c.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function k(){document.pointerLockElement===c||document.mozPointerLockElement===c||document.webkitPointerLockElement===c?(console.debug("Pointer was locked!"),c.isPointerLockEnabled=!0,c.removeEventListener(g,e,!1)):(console.debug("Pointer was unlocked."),c.isPointerLockEnabled=!1,c.addEventListener(g,e,!1))}function b(b){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",k,!1);document.addEventListener("mozpointerlockchange",k,!1);document.addEventListener("webkitpointerlockchange",
k,!1);document.addEventListener("pointerlockerror",b,!1);document.addEventListener("mozpointerlockerror",b,!1);document.addEventListener("webkitpointerlockerror",b,!1);c.addEventListener(g,e,!1);c.isRelativeMouse=!0};BWFLA.hideClientCursor=function(c){c.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(c){c.getDisplay().showCursor(!0)};