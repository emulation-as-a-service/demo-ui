var EaasClient=EaasClient||{};
EaasClient.Client=function(a,f){function d(a){var c=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(a,l){return"undefined"!=typeof c[l]?c[l]:a})}function h(a){var c={};if(!a)return c;a.split("\x26").forEach(function(a){a=a.split("\x3d");c[a[0]]=decodeURIComponent(a[1])});return c}function k(a){var c=document.getElementsByTagName("script"),l;for(l in c){var b="eaas-client.js";if("undefined"!=typeof c[l].src&&-1!=c[l].src.indexOf(b))var e=c[l].src}var g=e.substring(0,e.indexOf(b))+
"xpra/";$.when($.getScript(g+"/eaas-xpra.js"),$.getScript(g+"/js/lib/jquery-ui.js"),$.getScript(g+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(g+"/js/lib/bencode.js"),$.getScript(g+"/js/lib/zlib.js"),$.getScript(g+"/js/lib/lz4.js"),$.getScript(g+"/js/lib/forge.js"),$.getScript(g+"/js/lib/broadway/Decoder.js"),$.getScript(g+"/js/lib/aurora/aurora-xpra.js"),$.getScript(g+"/js/Utilities.js"),$.getScript(g+"/js/Keycodes.js"),$.getScript(g+"/js/Notifications.js"),$.getScript(g+"/js/MediaSourceUtil.js"),
$.getScript(g+"/js/Window.js"),$.getScript(g+"/js/Protocol.js"),$.getScript(g+"/js/Client.js"),$.getScript(g+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){loadXpra(a,g)})}xpraShapes={xpraWidth:1024,xpraHeight:768,xpraDPI:96};this.setXpraShapes=function(a,c,b){xpraShapes={xpraWidth:a,xpraHeight:c,xpraDPI:b}};var b=this,e=a.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.params=this.driveId=this.networkId=this.componentId=null;var n=!1;this.pollState=function(a){$.get(e+
d("/components/{0}/state",b.componentId)).then(function(a,l,f){n?(a=a.state,"OK"==a?b.keepalive():"INACTIVE"==a?location.reload():b._onError("Invalid component state: "+a)):$.get(e+d("/components/{0}/controlurls",b.componentId)).then(function(a,c,l){"undefined"!==typeof a.xpra?(b.params=h(a.xpra.substring(a.xpra.indexOf("#")+1)),k(a.xpra)):(b.params=h(a.guacamole.substring(a.guacamole.indexOf("#")+1)),b.establishGuacamoleTunnel(a.guacamole));b.pollStateInterval=setInterval(b.pollState,1500);n=!0;
for(a=0;a<m.length;a++)if(m[a])m[a]()})}).fail(function(){b._onError("connection failed")})};var m=[];this.addOnConnectListener=function(a){console.log("hasConnected, after"+n);if(n)return a(),{remove:function(){}};var c=m.push(a)-1;return{remove:function(){delete m[c]}}};this._onError=function(a){this.pollStateInterval&&clearInterval(this.pollStateInterval);this.keepaliveIntervalId&&clearInterval(this.keepaliveIntervalId);this.guac&&this.guac.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"})};
this._onResize=function(a,c){f.style.width=a;f.style.height=c;if(this.onResize)this.onResize(a,c)};this.keepalive=function(){var a=null;null!=b.networkId?a=d("/networks/{0}/keepalive",b.networkId):null!=b.componentId&&(a=d("/components/{0}/keepalive",b.componentId));$.post(e+a)};this.establishGuacamoleTunnel=function(a){window.onbeforeunload=function(){this.guac.disconnect()}.bind(this);$.fn.focusWithoutScrolling=function(){var a=window.scrollX,c=window.scrollY;this.focus();window.scrollTo(a,c);return this};
this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);f.insertBefore(a,f.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var c=new Guacamole.Mouse(a),b=new Guacamole.Mouse.Touchpad(a),e=new BwflaMouse(this.guac);c.onmousedown=b.onmousedown=e.onmousedown;c.onmouseup=b.onmouseup=e.onmouseup;c.onmousemove=b.onmousemove=e.onmousemove;c=new Guacamole.Keyboard(a);
c.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);c.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=function(a,c){var d={type:"machine"};d.environment=a;"undefined"!==typeof c&&(d.keyboardLayout=c.keyboardLayout,d.keyboardModel=c.keyboardModel,d.object=c.object,null==c.object&&(d.software=c.software),d.userContext=
c.userContext);$.ajax({type:"POST",url:e+"/components",data:JSON.stringify(d),contentType:"application/json"}).then(function(a,c,e){b.componentId=a.id;b.driveId=a.driveId;b.pollState()},function(a){b._onError($.parseJSON(a.responseText))})};this.getScreenshotUrl=function(){return e+d("/components/{0}/screenshot",b.componentId)};this.getPrintUrl=function(){return e+d("/components/{0}/print",b.componentId)};this.stopEnvironment=function(){"undefined"!==typeof this.guac&&this.guac.disconnect();this.pollStateInterval&&
clearInterval(this.pollStateInterval);$.ajax({type:"GET",url:e+d("/components/{0}/stop",b.componentId),async:!1});$(f).empty()};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(a,
c){$.ajax({type:"POST",url:e+d("/components/{0}/snapshot",b.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(a,b,e){c(a,b)})};this.changeMedia=function(a,c){$.ajax({type:"POST",url:e+d("/components/{0}/changeMedia",b.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(a,b,e){c(a,b)})};this.startEnvironmentWithInternet=function(a,b,d){$.ajax({type:"POST",url:e+"/components",data:JSON.stringify({environment:a,keyboardLayout:b,keyboardModel:d}),
contentType:"application/json"}).done(function(a){this.tmpdata=a;$.ajax({type:"POST",url:e+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).done(function(a){this.pollState(this.tmpdata.controlUrl.replace(/([^:])(\/\/+)/g,"$1/"),this.tmpdata.id)}.bind(this)).fail(function(a,b,c){this._onError($.parseJSON(a.responseText))}.bind(this))}.bind(this)).fail(function(a,b,c){}.bind(this))}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(a,f,d){var h="on"+f;if(h in a){"__bwFlaEventHandlers__"in a||(a.constructor.prototype.__bwFlaEventHandlers__={});h in a.__bwFlaEventHandlers__||(a.__bwFlaEventHandlers__[h]=[]);var k=a.__bwFlaEventHandlers__[h];k.push(d);null==a[h]&&(a[h]=function(){var b=arguments;k.forEach(function(e){e.apply(a,b)})})}else console.error("Event "+f+" not supported!")};
BWFLA.unregisterEventCallback=function(a,f,d){"__bwFlaEventHandlers__"in a&&(a=a.__bwFlaEventHandlers__["on"+f],null!=a&&(d=a.indexOf(d),-1<d&&a.splice(d,1)))};
var BwflaMouse=function(a){function f(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);h.push(a)}function d(){for(;0<h.length;)a.sendMouseState(h.shift());k=null;b=!1}var h=[],k=null,b=!1;this.onmousedown=function(a){null!=k&&window.clearTimeout(k);k=window.setTimeout(d,100);f(a);b=!0};this.onmouseup=function(a){null!=k&&window.clearTimeout(k);k=window.setTimeout(d,150);f(a);b=!0};this.onmousemove=function(d){1==b?f(d):a.sendMouseState(d)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(a,f){function d(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a?(console.debug("Pointer was locked!"),a.isPointerLockEnabled=!0,a.removeEventListener(f,d,!1)):(console.debug("Pointer was unlocked."),a.isPointerLockEnabled=!1,a.addEventListener(f,d,!1))}function k(a){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",k,!1);document.addEventListener("mozpointerlockerror",k,!1);document.addEventListener("webkitpointerlockerror",k,!1);a.addEventListener(f,d,!1);a.isRelativeMouse=!0};BWFLA.hideClientCursor=function(a){a.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(a){a.getDisplay().showCursor(!0)};