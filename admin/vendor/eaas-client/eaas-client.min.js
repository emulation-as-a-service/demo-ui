var EaasClient=EaasClient||{};
EaasClient.Client=function(c,g){function e(b){var a=Array.prototype.slice.call(arguments,1);return b.replace(/{(\d+)}/g,function(b,d){return"undefined"!=typeof a[d]?a[d]:b})}window.onbeforeunload=function(){this.disconnect();this.release()}.bind(this);xpraShapes={xpraWidth:1024,xpraHeight:768,xpraDPI:96};this.setXpraShapes=function(b,a,d){xpraShapes={xpraWidth:b,xpraHeight:a,xpraDPI:d}};var d=this,f=c.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.pollStateIntervalId=this.driveId=this.networkId=
this.componentId=null;this.pollState=function(){$.get(f+e("/components/{0}/state",d.componentId)).then(function(b,a,c){b=b.state;"OK"==b?d.keepalive():"INACTIVE"==b?location.reload():d._onFatalError("Invalid component state: "+b)}).fail(function(){d._onFatalError("connection failed")})};this._onFatalError=function(b){this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);this.disconnect();if(this.onError)this.onError(b||{error:"No error message specified"});console.error(b)};this._onResize=
function(b,a){g.style.width=b;g.style.height=a;if(this.onResize)this.onResize(b,a)};this.keepalive=function(){var b=null;null!=d.networkId?b=e("/networks/{0}/keepalive",d.networkId):null!=d.componentId&&(b=e("/components/{0}/keepalive",d.componentId));$.post(f+b)};this.establishGuacamoleTunnel=function(b){$.fn.focusWithoutScrolling=function(){var a=window.scrollX,b=window.scrollY;this.focus();window.scrollTo(a,b);return this};if(this.guac){var a=this.guac.getDisplay().getElement();$(a).remove()}this.guac=
new Guacamole.Client(new Guacamole.HTTPTunnel(b.split("#")[0]));b=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);g.insertBefore(b,g.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var a=new Guacamole.Mouse(b),d=new Guacamole.Mouse.Touchpad(b),c=new BwflaMouse(this.guac);a.onmousedown=d.onmousedown=c.onmousedown;a.onmouseup=d.onmouseup=c.onmouseup;a.onmousemove=d.onmousemove=c.onmousemove;a=new Guacamole.Keyboard(b);
a.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);a.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);$(b).attr("tabindex","0");$(b).css("outline","0");$(b).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=function(b,a){var c={type:"machine"};c.environment=b;"undefined"!==typeof a&&(c.keyboardLayout=a.keyboardLayout,c.keyboardModel=a.keyboardModel,c.object=a.object,null==a.object&&(c.software=a.software),c.userContext=
a.userContext);var e=$.Deferred();console.log("Starting environment "+b+"...");$.ajax({type:"POST",url:f+"/components",data:JSON.stringify(c),contentType:"application/json"}).then(function(a,c,f){console.log("Environment "+b+" started.");d.componentId=a.id;d.driveId=a.driveId;d.isStarted=!0;d.pollStateIntervalId=setInterval(d.pollState,1500);e.resolve()},function(a){d._onFatalError($.parseJSON(a.responseText));e.reject()});return e.promise()};this.connect=function(){var b=$.Deferred();if(!this.isStarted)return d._onFatalError("Environment was not started properly!"),
b.reject(),b.promise();console.log("Connecting viewer...");$.get(f+e("/components/{0}/controlurls",d.componentId)).done(function(a,c,e){if("undefined"!==typeof a.guacamole)c=a.guacamole,a=d.establishGuacamoleTunnel;else if("undefined"!==typeof a.xpra)c=a.xpra,a=d.prepareAndLoadXpra;else{console.error("Unsupported connector type: "+a);b.reject();return}a.call(d,c);console.log("Viewer connected successfully.");b.resolve()}).fail(function(a){console.error("Connecting viewer failed!");d._onFatalError($.parseJSON(a.responseText));
b.reject()});return b.promise()};this.disconnect=function(){var b=$.Deferred();if(!this.isStarted)return d._onFatalError("Environment was not started properly!"),b.reject(),b.promise();console.log("Disconnecting viewer...");this.guac&&this.guac.disconnect();console.log("Viewer disconnected successfully.");b.resolve();return b.promise()};this.checkpoint=function(){var b=$.Deferred();if(!this.isStarted)return d._onFatalError("Environment was not started properly!"),b.reject(),b.promise();console.log("Checkpointing session...");
$.ajax({type:"POST",url:f+e("/components/{0}/checkpoint",d.componentId),timeout:3E4}).done(function(a,c,d){a=a.environment_id;console.log("Checkpoint created: "+a);b.resolve(a)}).fail(function(a,c,d){a=$.parseJSON(a.responseText);null!==a.message&&console.error("Server-Error:"+a.message);null!==d&&console.error("Ajax-Error: "+d);console.error("Checkpointing failed!");b.reject()});return b.promise()};this.getScreenshotUrl=function(){return f+e("/components/{0}/screenshot",d.componentId)};this.getPrintUrl=
function(){return f+e("/components/{0}/print",d.componentId)};this.stopEnvironment=function(){"undefined"!==typeof this.guac&&this.guac.disconnect();this.pollStateIntervalId&&clearInterval(this.pollStateIntervalId);$.ajax({type:"GET",url:f+e("/components/{0}/stop",d.componentId),async:!1});$(g).empty()};this.clearTimer=function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);
this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.snapshot=function(b,a){$.ajax({type:"POST",url:f+e("/components/{0}/snapshot",d.componentId),data:JSON.stringify(b),contentType:"application/json"}).then(function(b,c,d){a(b,c)})};this.changeMedia=function(b,a){$.ajax({type:"POST",url:f+e("/components/{0}/changeMedia",d.componentId),data:JSON.stringify(b),contentType:"application/json"}).then(function(b,
c,d){a(b,c)})}};var BWFLA=BWFLA||{};BWFLA.registerEventCallback=function(c,g,e){var d="on"+g;if(d in c){"__bwFlaEventHandlers__"in c||(c.constructor.prototype.__bwFlaEventHandlers__={});d in c.__bwFlaEventHandlers__||(c.__bwFlaEventHandlers__[d]=[]);var f=c.__bwFlaEventHandlers__[d];f.push(e);null==c[d]&&(c[d]=function(){var b=arguments;f.forEach(function(a){a.apply(c,b)})})}else console.error("Event "+g+" not supported!")};
BWFLA.unregisterEventCallback=function(c,g,e){"__bwFlaEventHandlers__"in c&&(c=c.__bwFlaEventHandlers__["on"+g],null!=c&&(e=c.indexOf(e),-1<e&&c.splice(e,1)))};
var BwflaMouse=function(c){function g(a){a=new Guacamole.Mouse.State(a.x,a.y,a.left,a.middle,a.right,a.up,a.down);d.push(a)}function e(){for(;0<d.length;)c.sendMouseState(d.shift());f=null;b=!1}var d=[],f=null,b=!1;this.onmousedown=function(a){null!=f&&window.clearTimeout(f);f=window.setTimeout(e,100);g(a);b=!0};this.onmouseup=function(a){null!=f&&window.clearTimeout(f);f=window.setTimeout(e,150);g(a);b=!0};this.onmousemove=function(a){1==b?g(a):c.sendMouseState(a)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(c,g){function e(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(c.requestPointerLock=c.requestPointerLock||c.mozRequestPointerLock||c.webkitRequestPointerLock,c.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function d(){document.pointerLockElement===c||document.mozPointerLockElement===c||document.webkitPointerLockElement===c?(console.debug("Pointer was locked!"),c.isPointerLockEnabled=!0,c.removeEventListener(g,e,!1)):(console.debug("Pointer was unlocked."),c.isPointerLockEnabled=!1,c.addEventListener(g,e,!1))}function f(b){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",d,!1);document.addEventListener("mozpointerlockchange",d,!1);document.addEventListener("webkitpointerlockchange",
d,!1);document.addEventListener("pointerlockerror",f,!1);document.addEventListener("mozpointerlockerror",f,!1);document.addEventListener("webkitpointerlockerror",f,!1);c.addEventListener(g,e,!1);c.isRelativeMouse=!0};BWFLA.hideClientCursor=function(c){c.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(c){c.getDisplay().showCursor(!0)};