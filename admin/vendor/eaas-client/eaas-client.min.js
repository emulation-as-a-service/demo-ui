var EaasClient=EaasClient||{};
EaasClient.Client=function(b,f){function g(a){var m=Array.prototype.slice.call(arguments,1);return a.replace(/{(\d+)}/g,function(n,a){return"undefined"!=typeof m[a]?m[a]:n})}function h(a){var m={};if(!a)return m;a.split("\x26").forEach(function(a){a=a.split("\x3d");m[a[0]]=decodeURIComponent(a[1])})}function l(a){var m=document.getElementsByTagName("script"),b;for(b in m){var c="eaas-client.js";if("undefined"!=typeof m[b].src&&-1!=m[b].src.indexOf(c))var v=m[b].src}var k=v.substring(0,v.indexOf(c))+
"xpra/";$.when($.getScript(k+"/js/lib/jquery-ui.js"),$.getScript(k+"/js/lib/jquery.ba-throttle-debounce.js"),$.getScript(k+"/js/lib/bencode.js"),$.getScript(k+"/js/lib/zlib.js"),$.getScript(k+"/js/lib/lz4.js"),$.getScript(k+"/js/lib/forge.js"),$.getScript(k+"/js/lib/broadway/Decoder.js"),$.getScript(k+"/js/lib/aurora/aurora-xpra.js"),$.getScript(k+"/js/Utilities.js"),$.getScript(k+"/js/Keycodes.js"),$.getScript(k+"/js/Notifications.js"),$.getScript(k+"/js/MediaSourceUtil.js"),$.getScript(k+"/js/Window.js"),
$.getScript(k+"/js/Protocol.js"),$.getScript(k+"/js/Client.js"),$.Deferred(function(a){$(a.resolve)})).done(function(){t(a,k)})}xpraShapes={xpraWidth:1024,xpraHeight:768,xpraDPI:96};this.setXpraShapes=function(a,m,b){xpraShapes={xpraWidth:a,xpraHeight:m,xpraDPI:b}};var c=this,d=b.replace(/([^:])(\/\/+)/g,"$1/").replace(/\/+$/,"");this.params=this.driveId=this.networkId=this.componentId=null;var p=!1;this.pollState=function(a){$.get(d+g("/components/{0}/state",c.componentId)).then(function(a,b,r){p?
(a=a.state,"OK"==a?c.keepalive():"INACTIVE"==a?location.reload():c._onError("Invalid component state: "+a)):$.get(d+g("/components/{0}/controlurls",c.componentId)).then(function(a,b,m){"undefined"!==typeof a.xpra?(c.params=h(a.xpra.substring(a.xpra.indexOf("#")+1)),l(a.xpra)):(c.params=h(a.guacamole.substring(a.guacamole.indexOf("#")+1)),c.establishGuacamoleTunnel(a.guacamole));c.pollStateInterval=setInterval(c.pollState,1500);p=!0;for(a=0;a<q.length;a++)if(q[a])q[a]()})},function(a){c._onError($.parseJSON(a.responseText))})};
var q=[];this.addOnConnectListener=function(a){console.log("hasConnected, after"+p);if(p)return a(),{remove:function(){}};var b=q.push(a)-1;return{remove:function(){delete q[b]}}};this._onError=function(a){this.pollStateInterval&&clearInterval(this.pollStateInterval);this.guac&&this.guac.disconnect();if(this.onError)this.onError(a||{error:"No error message specified"})};this._onResize=function(a,b){f.style.width=a;f.style.height=b;if(this.onResize)this.onResize(a,b)};this.keepalive=function(){var a=
null;null!=c.networkId?a=g("/networks/{0}/keepalive",c.networkId):null!=c.componentId&&(a=g("/components/{0}/keepalive",c.componentId));$.post(d+a)};this.establishGuacamoleTunnel=function(a){window.onbeforeunload=function(){this.guac.disconnect()}.bind(this);$.fn.focusWithoutScrolling=function(){var a=window.scrollX,b=window.scrollY;this.focus();window.scrollTo(a,b);return this};this.guac=new Guacamole.Client(new Guacamole.HTTPTunnel(a.split("#")[0]));a=this.guac.getDisplay().getElement();BWFLA.hideClientCursor(this.guac);
f.insertBefore(a,f.firstChild);BWFLA.registerEventCallback(this.guac.getDisplay(),"resize",this._onResize.bind(this));this.guac.connect();var b=new Guacamole.Mouse(a),c=new Guacamole.Mouse.Touchpad(a),d=new BwflaMouse(this.guac);b.onmousedown=c.onmousedown=d.onmousedown;b.onmouseup=c.onmouseup=d.onmouseup;b.onmousemove=c.onmousemove=d.onmousemove;b=new Guacamole.Keyboard(a);b.onkeydown=function(a){this.guac.sendKeyEvent(1,a)}.bind(this);b.onkeyup=function(a){this.guac.sendKeyEvent(0,a)}.bind(this);
$(a).attr("tabindex","0");$(a).css("outline","0");$(a).mouseenter(function(){$(this).focusWithoutScrolling()});if(this.onReady)this.onReady()};this.startEnvironment=function(a,b){var n={type:"machine"};n.environment=a;"undefined"!==typeof b&&(n.keyboardLayout=b.keyboardLayout,n.keyboardModel=b.keyboardModel,n.object=b.object,null==b.object&&(n.software=b.software));$.ajax({type:"POST",url:d+"/components",data:JSON.stringify(n),contentType:"application/json"}).then(function(a,b,d){c.componentId=a.id;
c.driveId=a.driveId;c.pollState()},function(a){c._onError($.parseJSON(a.responseText))})};this.getScreenshotUrl=function(){return d+g("/components/{0}/screenshot",c.componentId)};this.getPrintUrl=function(){return d+g("/components/{0}/print",c.componentId)};this.stopEnvironment=function(){"undefined"!==typeof this.guac&&this.guac.disconnect();this.pollStateInterval&&clearInterval(this.pollStateInterval);$.ajax({type:"GET",url:d+g("/components/{0}/stop",c.componentId),async:!1});$(f).empty()};this.clearTimer=
function(){clearInterval(this.keepaliveIntervalId)};this.release=function(){this.stopEnvironment();this.clearTimer()};this.sendCtrlAltDel=function(){this.guac.sendKeyEvent(1,65513);this.guac.sendKeyEvent(1,65507);this.guac.sendKeyEvent(1,65535);this.guac.sendKeyEvent(0,65513);this.guac.sendKeyEvent(0,65507);this.guac.sendKeyEvent(0,65535)};this.changeMedia=function(a,b){$.ajax({type:"POST",url:d+g("/components/{0}/changeMedia",c.componentId),data:JSON.stringify(a),contentType:"application/json"}).then(function(a,
c,d){b(a,c)})};var t=function(a,b){function c(a){return window.location.getParameter(a)}function d(a,b){a=window.location.getParameter(a);return null==a?b:0<=["true","on","1"].indexOf(String(a).toLowerCase())}window.location.getParameter||(window.location.getParameter=function(a){if(!this.queryStringParams){for(var b={},c,d=/\+/g,g=/([^&=]+)=?([^&]*)/g,f=window.location.search.substring(1);c=g.exec(f);)b[decodeURIComponent(c[1].replace(d," "))]=decodeURIComponent(c[2].replace(d," "));this.queryStringParams=
b}return this.queryStringParams[a]});window.oncontextmenu=function(a){return!1};$(document).ready(function(){var g=c("username")||null,k=c("password")||null,f=c("sound")||"true",h=c("audio_codec")||"opus+mka",l=c("encoding")||null,m=c("action")||"connect";c("submit");var n=a.substring(7,a.indexOf("8080")-1),q=a.substring(a.indexOf("8080")),r=c("encryption")||null,p=c("key")||null,w=c("keyboard_layout")||null,x=c("start"),t=c("exit_with_children")||"",z=c("exit_with_client")||"",A=d("sharing",!1),
B=d("video",!1),C=d("mediasource_video",!1),D=d("normal_fullscreen",!1),E=d("remote_logging",!0),F=d("debug",!1),G=d("insecure",!1),H=d("ignore_audio_blacklist",!1),y=d("clipboard",!0),e=new XpraClient("emulator-container");e.debug=F;e.remote_logging=E;e.sharing=A;e.insecure=G;e.clipboard_enabled=y;B?(e.supported_encodings.push("h264"),C&&e.supported_encodings.push("vp8+webm","h264+mp4","mpeg4+mp4")):l&&"auto"!==l&&e.enable_encoding(l);m&&"connect"!=m&&(sns={mode:m},x&&(sns.start=[x]),t&&(sns["exit-with-children"]=
!0),z&&(sns["exit-with-client"]=!0),e.start_new_session=sns);D&&(e.normal_fullscreen_mode=!0);f&&(e.audio_enabled=!0,console.log("sound enabled, audio codec string: "+h),h&&0<h.indexOf(":")&&(f=h.split(":"),e.audio_framework=f[0],e.audio_codec=f[1]),e.audio_mediasource_enabled=d("mediasource",!0),e.audio_aurora_enabled=d("aurora",!0));w&&(e.keyboard_layout=w);g&&(e.username=g);k&&(e.authentication_key=k);r&&(e.encryption=r,p&&(e.encryption_key=p));e.init(H);g="https:"==document.location.protocol;
XpraClient.prototype._do_connect=function(a){this.protocol=a&&!XPRA_CLIENT_FORCE_NO_WORKER?new XpraProtocolWorkerHost:new XpraProtocol;this.protocol.set_packet_handler(this._route_packet,this);a="ws://";this.ssl&&(a="wss://");a+=this.host;a+=":"+this.port;this.protocol.open=function(a){var c=this;this.worker=new Worker(b+"/js/Protocol.js");this.worker.addEventListener("message",function(b){var d=b.data;switch(d.c){case "r":c.worker.postMessage({c:"o",u:a});break;case "p":c.packet_handler&&c.packet_handler(d.p,
c.packet_ctx);break;case "l":console.log(d.t);break;default:console.error("got unknown command from worker"),console.error(b.data)}},!1)};this.protocol.open(a);var c=this;this.hello_timer=setTimeout(function(){c.disconnect_reason="Did not receive hello before timeout reached, not an Xpra server?";c.close()},this.HELLO_TIMEOUT)};XpraClient.prototype._get_desktop_size=function(){return[xpraShapes.xpraWidth,xpraShapes.xpraHeight]};XpraClient.prototype._get_DPI=function(){return xpraShapes.xpraDPI};e.connect=
XpraClient.prototype.connect=function(a,c,d){console.log("connecting to xpra server "+a+":"+c+" with ssl: "+d);this.host=a;this.port=c;this.ssl=d;if(!this.encryption||this.encryption_key&&""!=this.encryption_key)if(window.Worker){console.log("we have webworker support");var e=this;a=new Worker(b+"/js/lib/wsworker_check.js");a.addEventListener("message",function(a){switch(a.data.result){case !0:console.log("we can use websocket in webworker");e._do_connect(!0);break;case !1:console.log("we can't use websocket in webworker, won't use webworkers");
e._do_connect(!1);break;default:console.log("client got unknown message from worker"),e._do_connect(!1)}},!1);a.postMessage({cmd:"check"})}else console.log("no webworker support at all.");else this.callback_close("no key specified for encryption")};e._new_window=function(a,b,c,d,e,g,f,h){var u=document.createElement("div");u.id=String(a);var k=document.createElement("canvas");u.appendChild(k);document.getElementById("emulator-container").appendChild(u);k.width=d;k.height=e;b=new XpraWindow(this,k,
a,b,c,d,e,g,f,h,this._window_geometry_changed,this._window_mouse_move,this._window_mouse_click,this._window_set_focus,this._window_closed);b.debug=this.debug;this.id_to_window[a]=b;f||(this.normal_fullscreen_mode&&"NORMAL"==b.windowtype&&(b.undecorate(),b.set_maximized(!0)),f=b.get_internal_geometry(),this.protocol.send(["map-window",a,f.x,f.y,f.w,f.h,this._get_client_properties(b)]),this._window_set_focus(b));b.undecorate();b.ensure_visible();b.fill_screen();b.set_maximized(!0)};XpraWindow.prototype.getMouse=
function(a){var b=a.clientX+jQuery(document).scrollLeft(),c=a.clientY+jQuery(document).scrollTop();isNaN(b)||isNaN(c)?isNaN(this.last_mouse_x)||isNaN(this.last_mouse_y)?c=b=0:(b=this.last_mouse_x,c=this.last_mouse_y):(this.last_mouse_x=b,this.last_mouse_y=c);var d=0;"which"in a?d=Math.max(0,a.which):"button"in a&&(d=Math.max(0,a.button)+1);a=$("#emulator-container").offset();b-=a.left;c-=a.top;return{x:b,y:c,button:d}};e.connect(n,q,g);y&&(n=$("#pasteboard"),n.on("paste",function(a){a=(a.originalEvent||
a).clipboardData.getData("text/plain");e.send_clipboard_token(unescape(encodeURIComponent(a)));return!1}),n.on("copy",function(a){a=e.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));$("#pasteboard").select();e.clipboard_pending=!1;return!0}),n.on("cut",function(a){a=e.get_clipboard_buffer();$("#pasteboard").text(decodeURIComponent(escape(a)));$("#pasteboard").select();e.clipboard_pending=!1;return!0}),$("#emulator-container").on("click",function(a){e.clipboard_pending&&
(e.get_clipboard_buffer(),$("#pasteboard").text(e.clipboard_buffer),$("#pasteboard").select(),a=!0,window.clipboardData&&window.clipboardData.setData?clipboardData.setData("Text",this.clipboard_buffer):a=document.execCommand("copy"),a&&(e.clipboard_pending=!1))}))})};this.startEnvironmentWithInternet=function(a,b,c){$.ajax({type:"POST",url:d+"/components",data:JSON.stringify({environment:a,keyboardLayout:b,keyboardModel:c}),contentType:"application/json"}).done(function(a){this.tmpdata=a;$.ajax({type:"POST",
url:d+"/networks",data:JSON.stringify({components:[{componentId:a.id}],hasInternet:!0}),contentType:"application/json"}).done(function(a){this.pollState(this.tmpdata.controlUrl.replace(/([^:])(\/\/+)/g,"$1/"),this.tmpdata.id)}.bind(this)).fail(function(a,b,c){this._onError($.parseJSON(a.responseText))}.bind(this))}.bind(this)).fail(function(a,b,c){}.bind(this))}};var BWFLA=BWFLA||{};
BWFLA.registerEventCallback=function(b,f,g){var h="on"+f;if(h in b){"__bwFlaEventHandlers__"in b||(b.constructor.prototype.__bwFlaEventHandlers__={});h in b.__bwFlaEventHandlers__||(b.__bwFlaEventHandlers__[h]=[]);var l=b.__bwFlaEventHandlers__[h];l.push(g);null==b[h]&&(b[h]=function(){var c=arguments;l.forEach(function(d){d.apply(b,c)})})}else console.error("Event "+f+" not supported!")};
BWFLA.unregisterEventCallback=function(b,f,g){"__bwFlaEventHandlers__"in b&&(b=b.__bwFlaEventHandlers__["on"+f],null!=b&&(g=b.indexOf(g),-1<g&&b.splice(g,1)))};
var BwflaMouse=function(b){function f(b){b=new Guacamole.Mouse.State(b.x,b.y,b.left,b.middle,b.right,b.up,b.down);h.push(b)}function g(){for(;0<h.length;)b.sendMouseState(h.shift());l=null;c=!1}var h=[],l=null,c=!1;this.onmousedown=function(b){null!=l&&window.clearTimeout(l);l=window.setTimeout(g,100);f(b);c=!0};this.onmouseup=function(b){null!=l&&window.clearTimeout(l);l=window.setTimeout(g,150);f(b);c=!0};this.onmousemove=function(d){1==c?f(d):b.sendMouseState(d)}},BWFLA=BWFLA||{};
BWFLA.requestPointerLock=function(b,f){function g(){"pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document?(b.requestPointerLock=b.requestPointerLock||b.mozRequestPointerLock||b.webkitRequestPointerLock,b.requestPointerLock()):(console.warn("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."),alert("Your browser does not support the PointerLock API!\nUsing relative mouse is not possible.\n\nMouse input will be disabled for this virtual environment."))}
function h(){document.pointerLockElement===b||document.mozPointerLockElement===b||document.webkitPointerLockElement===b?(console.debug("Pointer was locked!"),b.isPointerLockEnabled=!0,b.removeEventListener(f,g,!1)):(console.debug("Pointer was unlocked."),b.isPointerLockEnabled=!1,b.addEventListener(f,g,!1))}function l(b){console.warn("Pointer lock failed!");alert("Pointer lock failed!")}document.addEventListener("pointerlockchange",h,!1);document.addEventListener("mozpointerlockchange",h,!1);document.addEventListener("webkitpointerlockchange",
h,!1);document.addEventListener("pointerlockerror",l,!1);document.addEventListener("mozpointerlockerror",l,!1);document.addEventListener("webkitpointerlockerror",l,!1);b.addEventListener(f,g,!1);b.isRelativeMouse=!0};BWFLA.hideClientCursor=function(b){b.getDisplay().showCursor(!1)};BWFLA.showClientCursor=function(b){b.getDisplay().showCursor(!0)};